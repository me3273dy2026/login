<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg1:#0f2027;
  --bg2:#203a43;
  --bg3:#2c5364;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  min-height:100vh;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  justify-content:center;
  padding:26px 12px 90px;
}

.card{
  background:#fff;
  width:100%;
  max-width:560px;
  border-radius:20px;
  padding:26px;
  box-shadow:0 20px 50px rgba(0,0,0,.28);
}
.dateChip{
  display:inline-block;
  padding:6px 10px;
  margin:6px 6px 0 0;
  border-radius:8px;
  font-size:13px;
  font-weight:600;
}

.date-green{
  background:#c8e6c9;
  color:#1b5e20;
}

.date-red{
  background:#ffcdd2;
  color:#b71c1c;
}
.header{text-align:center}
.header h1{margin:0;color:#203a43;font-size:22px}
.header h2{margin:4px 0 0;font-size:14px;color:#666}

.infoBox{
  background:#f5f7fa;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
}

.loading{text-align:center;font-weight:600;color:#555}

/* Upcoming box */
.upcomingBox{
  background:#fdecea;
  border:2px solid #e53935;
  color:#b71c1c;
  font-weight:700;
  text-align:center;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
  animation:blink 1.5s infinite;
}

@keyframes blink{
  0%{opacity:1}
  50%{opacity:.45}
  100%{opacity:1}
}

/* Past box */
.pastBox{
  background:#e8f5e9;
  border:1px solid #c8e6c9;
  color:#1b5e20;
  font-weight:600;
  text-align:center;
  padding:12px;
  border-radius:14px;
  margin-top:10px;
}

/* Buttons */
button{
  width:100%;
  padding:13px;
  margin-top:14px;
  border:none;
  border-radius:30px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}
.detailBlock{
  background:#eef3f7;
  border-radius:12px;
  padding:12px;
  margin-top:10px;
}
.detailTitle{
  font-weight:700;
  color:#203a43;
  margin-bottom:6px;
}
.detailText{
  font-size:14px;
  color:#444;
}
.btn-primary{
  background:linear-gradient(135deg,#2c5364,#203a43);
  color:#fff;
}
.btn-attendance{
  background: linear-gradient(135deg,#2e7d32,#1b5e20);
  color:#fff;
}
.btn-attendance:hover{
  opacity:0.92;
}
.btn-logout{
  background:linear-gradient(135deg,#e74c3c,#c0392b);
  color:#fff;
}

/* Sections */
.section{
  margin-top:10px;
  border-radius:14px;
  overflow:hidden;
  border:1px solid #e0e0e0;
}
.section-header{
  background:#fafafa;
  padding:12px 14px;
  font-weight:700;
  cursor:pointer;
}
.section-body{padding:14px;display:none}
.section.open .section-body{display:block}

/* Marks */
.marksWrapper{text-align:center}
.marksBox{
  display:inline-block;
  padding:12px 22px;
  border-radius:10px;
  font-size:20px;
  font-weight:700;
  margin:14px auto 6px;
}
.marks-green{background:#2e7d32;color:#fff}
.marks-yellow{background:#f9a825;color:#000}
.marks-orange{background:#ef6c00;color:#fff}
.marks-red{background:#c62828;color:#fff}
.marksMsg{font-size:14px;font-weight:600}

.greenBox{
  background:#e8f5e9;
  padding:12px;
  border-radius:10px;
  margin-top:8px;
}
.yellowBox{
  background:#fffde7;
  padding:12px;
  border-radius:10px;
  margin-top:8px;
}

/* Logout overlay */
#logoutOverlay{
  position:fixed;
  inset:0;
  background:rgba(15,32,39,.75);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:9999;
}
.logoutSpinner{
  width:48px;height:48px;
  border:5px solid #cfd8dc;
  border-top:5px solid #1abc9c;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
.logoutText{margin-top:14px;color:#fff;font-weight:700}
@keyframes spin{to{transform:rotate(360deg)}}

footer{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#0f2027;
  color:#cfd8dc;
  text-align:center;
  padding:10px;
  font-size:13px;
  font-weight:600;
}
footer div{font-size:12px;color:#90a4ae}
  #actionButtons{
  animation: fadeIn .35s ease;
}

@keyframes fadeIn{
  from{
    opacity:0;
    transform:translateY(6px);
  }
  to{
    opacity:1;
    transform:none;
  }
}
</style>
</head>

<body>

<div class="card">
  <div class="header">
    <h1 id="welcome"></h1>
    <h2>ME3273 Â· Seminar & Group Discussion</h2>
  </div>
<div id="attendanceBox" class="infoBox" style="display:none;text-align:center">
  Current attendance :
  <div id="attendanceValue"
       style="font-size:22px;font-weight:800;margin-top:6px">
  </div>
</div>
  <div id="loadingBox" class="infoBox loading">
    Fetching your detailsâ€¦
  </div>
  <div id="upcomingBox" style="display:none"></div>
  <div id="pastBox" style="display:none"></div>
  <div id="profileBox" class="infoBox" style="display:none">
  <div class="detailBlock">
    <div class="detailTitle">GD Topic</div>
    <div id="gdTopic">-</div>
  </div>

  <div class="detailBlock" style="margin-top:10px">
    <div class="detailTitle">GD Group Members</div>
    <div id="gdMembers">-</div>
  </div>

  <div class="detailBlock" style="margin-top:10px">
    <div class="detailTitle">Seminar Topic</div>
    <div id="seminarTopic">-</div>
  </div>
</div>
  <div id="actionButtons" style="display:none">
  <button id="perfBtn" class="btn-primary" disabled onclick="togglePanel()">
    View Performance Evaluation
  </button>
  <div id="perfPanel" style="display:none">
    <div class="section" onclick="toggleSection('GD')">
      <div class="section-header">Group Discussion</div>
      <div class="section-body" id="GD"></div>
    </div>
    <div class="section" onclick="toggleSection('SEMINAR')">
      <div class="section-header">Seminar</div>
      <div class="section-body" id="SEMINAR"></div>
    </div>
    <div class="section" onclick="toggleSection('PI')">
      <div class="section-header">Personal Interview</div>
      <div class="section-body" id="PI"></div>
    </div>
  </div>
  <button class="btn-attendance" onclick="toggleAttendanceDetails()">
  View Attendance Details
</button>
    <div id="attendanceLoadingMsg"
     style="display:none;
            margin-top:8px;
            color:#c62828;
            font-weight:600;
            text-align:center;">
  Loadingâ€¦ please wait
</div>
  <div id="attendancePanel" style="display:none;margin-top:14px">

  <div class="detailBlock" style="background:#e8f5e9">
    <div class="detailTitle">Attended</div>
    <div id="attendedDates"></div>
  </div>

  <div class="detailBlock" style="background:#fdecea;margin-top:10px">
    <div class="detailTitle">Absent</div>
    <div id="absentDates"></div>
  </div>

</div>
  <button id="logoutBtn" class="btn-logout" disabled onclick="logout()">Logout</button>
</div>
</div>
<footer>
  Developed by Dr. Rajesh Akula
  <div>Â© 2026 Â· IIEST Shibpur</div>
</footer>

<div id="logoutOverlay">
  <div class="logoutSpinner"></div>
  <div class="logoutText">Logging outâ€¦</div>
</div>

<script>
  const logoutOverlay = document.getElementById("logoutOverlay");
const BACKEND="https://script.google.com/macros/s/AKfycbwf5u8MUdVpmO95QhWVQhSlaJVRShesFLHMBcl_jxyPNkZQ31769Vx1kwJSITvS1HIqVA/exec";
const perfBtn   = document.getElementById("perfBtn");
const logoutBtn = document.getElementById("logoutBtn");
const welcome   = document.getElementById("welcome");
const loadingBox = document.getElementById("loadingBox");
const perfPanel = document.getElementById("perfPanel");
  const token = sessionStorage.getItem("token");

if(!token){
  sessionStorage.clear();
  alert("Session expired. Please login again.");
  window.location.replace("index.html");
}
  function getGDTopic(obj){
  return obj.topic || obj.gdTopic || obj.GDTopic || "â€”";
}

function getGDMembers(obj){
  return obj.members || obj.gdMembers || obj.groupMembers || obj.membersList || "â€”";
}

function getSeminarTopic(obj){
  return obj.topic || obj.seminarTopic || obj.SeminarTopic || "â€”";
}
function prettyDate(iso){
  const d=new Date(iso);
  const day=d.getDate();
  const suf=day%10===1&&day!==11?"st":day%10===2&&day!==12?"nd":day%10===3&&day!==13?"rd":"th";
  return `${day}${suf} ${d.toLocaleString("en",{month:"short"})} ${d.getFullYear()}`;
}
function isPast(iso){
  const today = new Date();
  today.setHours(0,0,0,0);

  const d = new Date(iso);
  d.setHours(0,0,0,0);

  return d < today;   // STRICTLY before today
}
function isToday(iso){
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm   = String(today.getMonth()+1).padStart(2,"0");
  const dd   = String(today.getDate()).padStart(2,"0");

  return iso === `${yyyy}-${mm}-${dd}`;
}
function normCategory(c){
  return String(c || "").toLowerCase().replace(/\s+/g,"");
}
loadAll();
function canShowUpcoming(isoDate){
  const now = new Date();

  // future date
  if(isoDate > getTodayISO()) return true;

  // today
  if(isoDate === getTodayISO()){
    const cutoff = new Date();
    cutoff.setHours(13, 50, 0, 0); // 1:50 PM
    return now < cutoff;
  }

  return false;
}

function getTodayISO(){
  const t = new Date();
  return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
}
  function before2PMOnDate(isoDate){
  // Current time in IST
  const nowIST = new Date(
    new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
  );

  const todayIST = new Date(
    nowIST.getFullYear(),
    nowIST.getMonth(),
    nowIST.getDate()
  );

  const d = new Date(isoDate);
  d.setHours(0,0,0,0);

  if(d.getTime() !== todayIST.getTime()) return false;

  return nowIST.getHours() < 14; // before 2 PM IST
}
function loadAll(){
  const loadingBox  = document.getElementById("loadingBox");
  const upcomingBox = document.getElementById("upcomingBox");
  const pastBox     = document.getElementById("pastBox");

  Promise.all([
    fetch(BACKEND,{method:"POST",
      body:new URLSearchParams({action:"dashboard",token})
    }).then(r=>r.json()),

    fetch(BACKEND,{method:"POST",
      body:new URLSearchParams({action:"getMyUpcomingAllocation",token})
    }).then(r=>r.json()),

    fetch(BACKEND,{method:"POST",
      body:new URLSearchParams({action:"getMyLastEvaluatedActivity",token})
    }).then(r=>r.json()),

    fetch(BACKEND,{method:"POST",
      body:new URLSearchParams({action:"getMyLatestPastAllocation",token})
    }).then(r=>r.json()),
    fetch(BACKEND,{
  method:"POST",
  body:new URLSearchParams({action:"getMyProfileDetails",token})
}).then(r=>r.json()),
    fetch(BACKEND,{method:"POST",
  body:new URLSearchParams({action:"getMyAttendance",token})
}).then(r=>r.json())
  ])
  .then(([dash, upcoming, evaluated, pastAlloc, profile, attendance])=>{

    loadingBox.style.display="none";

    if(dash.status !== "OK"){
      alert("Session invalid. Please login again.");
      sessionStorage.clear();
      location.replace("index.html");
      return;
    }

    welcome.innerText = `Welcome ${dash.name} (${dash.roll})`;
    if(profile.status === "OK"){
  document.getElementById("gdTopic").innerText =
    profile.gdTopic || "-";

  document.getElementById("seminarTopic").innerText =
    profile.seminarTopic || "-";

  document.getElementById("gdMembers").innerHTML =
    profile.members.length
      ? "<ul>" + profile.members.map(m=>`<li>${m}</li>`).join("") + "</ul>"
      : "<i>Not assigned</i>";

  document.getElementById("profileBox").style.display = "block";
}
    const attendanceBox   = document.getElementById("attendanceBox");
const attendanceValue = document.getElementById("attendanceValue");

if(attendance.status === "OK"){
  const p = Number(attendance.percent);

  attendanceValue.innerText = `${p}%`;
  attendanceValue.style.color = p >= 75 ? "#2e7d32" : "#c62828";

  attendanceBox.style.display = "block";
}

/* If nothing upcoming, show last allocation details */

 let hasUpcoming = false;
let upcomingMsgs = [];
let pendingMsgs  = [];
let doneMsgs     = [];

/* ========== UPCOMING (FUTURE) ========== */
if(upcoming.status === "FOUND"){
  if(canShowUpcoming(upcoming.date)){
    hasUpcoming = true;

    upcomingMsgs.push(`
      <div class="upcomingBox">
        Upcoming: You have <b>${upcoming.category}</b><br>
        on <b>${prettyDate(upcoming.date)}</b>
        ${upcoming.topic ? `<br>Topic: ${upcoming.topic}` : ""}
      </div>
    `);
  }
}

/* ========== TODAY (SPECIAL CASE) ========== */
if(
  pastAlloc.status === "FOUND" &&
  isToday(pastAlloc.date) &&
  before2PMOnDate(pastAlloc.date)
){
  hasUpcoming = true;

  upcomingMsgs.push(`
    <div class="upcomingBox">
      Today: You have <b>${pastAlloc.category}</b><br>
      on <b>${prettyDate(pastAlloc.date)}</b>
    </div>
  `);
}
     /* COMPLETED BUT NOT EVALUATED */
 if(
  pastAlloc.status === "FOUND" &&
  isPast(pastAlloc.date)
){

  const isEvaluatedSame =
  evaluated.status==="FOUND" &&
  evaluated.category === pastAlloc.category &&
  evaluated.date === pastAlloc.date;

if(!isEvaluatedSame){
  pendingMsgs.push(`
    <div class="pastBox"
         style="background:#fffde7;border:1px solid #fbc02d;color:#795548">
      Completed: You had <b>${pastAlloc.category}</b><br>
      on <b>${prettyDate(pastAlloc.date)}</b><br>
      <i>Evaluation under process</i>
    </div>
  `);
}
}

    /* COMPLETED & EVALUATED */
   if(
  evaluated.status==="FOUND" 
){
  doneMsgs.push(`
    <div class="pastBox">
      Completed: You had <b>${evaluated.category}</b><br>
      on <b>${prettyDate(evaluated.date)}</b><br>
      <i>Evaluation completed</i>
    </div>
  `);
}
    const allMessages = [
  ...upcomingMsgs,
  ...pendingMsgs,
  ...doneMsgs
];

if(!hasUpcoming){

  const nowIST = new Date(
    new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" })
  );

  const isBefore2PM = nowIST.getHours() < 14;

  const msg = isBefore2PM
    ? "You donâ€™t have any allocations for the coming week."
    : "Allocation for the coming week has not been done yet.";

  upcomingMsgs.unshift(`
    <div class="pastBox"
         style="background:#eef3f7;border:1px dashed #90a4ae;color:#455a64">
      ${msg}
    </div>
  `);
}
upcomingBox.innerHTML = [
  ...upcomingMsgs,
  ...pendingMsgs,
  ...doneMsgs
].join("");

upcomingBox.style.display = "block";
document.getElementById("actionButtons").style.display = "block";
    perfBtn.disabled = false;
    logoutBtn.disabled = false;
  })
  .catch(err=>{
    console.error(err);
    loadingBox.innerText = "Failed to load data. Please refresh.";
    document.getElementById("actionButtons").style.display = "none";
  });
}

function togglePanel(){
  perfPanel.style.display=perfPanel.style.display==="none"?"block":"none";
}

function toggleSection(type){
  const sec=document.getElementById(type).parentElement;
  sec.classList.toggle("open");
  const box=document.getElementById(type);
  if(box.innerHTML) return;

  box.innerHTML="Loadingâ€¦";

  fetch(BACKEND,{method:"POST",
    body:new URLSearchParams({action:"getMyPerformance",token,type})
  }).then(r=>r.json()).then(res=>{
    if(res.status!=="FOUND"){box.innerHTML="Not yet evaluated.";return;}

    const m=Number(res.marks??0);
    let c="marks-red",msg="Needs improvement. Donâ€™t give up.";
    if(m>=80){c="marks-green";msg="Very good. Keep going."}
    else if(m>=70){c="marks-yellow";msg="Good work. Aim higher."}
    else if(m>=60){c="marks-orange";msg="Fair effort. You can do better."}

    box.innerHTML=`
      <div><b>Date:</b> ${res.evaluationDate}</div>
      <div class="marksWrapper">
        <div class="marksBox ${c}">${m}/100</div>
        <div class="marksMsg">${msg}</div>
      </div>
      <div class="greenBox"><b>Positives</b><ol>${makeList(res.positives)}</ol></div>
      <div class="yellowBox"><b>Improvements</b><ol>${makeList(res.improvements)}</ol></div>`;
  });
}
function toggleAttendanceDetails(){
  const panel = document.getElementById("attendancePanel");
  const msg   = document.getElementById("attendanceLoadingMsg");

  panel.style.display =
    panel.style.display === "none" ? "block" : "none";

  // If already loaded once, donâ€™t fetch again
  if(panel.dataset.loaded) return;

  panel.dataset.loaded = "yes";
  msg.style.display = "block";   // ðŸ”´ SHOW loading message

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getMyAttendanceDetails",
      token
    })
  })
  .then(r => r.json())
  .then(res => {

    msg.style.display = "none";  // âœ… HIDE after success

    if(res.status !== "OK"){
      document.getElementById("attendedDates").innerHTML = "No data";
      document.getElementById("absentDates").innerHTML   = "No data";
      return;
    }

    renderDates("attendedDates", res.attended, "date-green");
    renderDates("absentDates",   res.absent,   "date-red");
  })
  .catch(err=>{
    console.error("Attendance details error:", err);
    msg.style.display = "none";  // âœ… HIDE on error
    document.getElementById("attendedDates").innerHTML="Failed to load";
    document.getElementById("absentDates").innerHTML="Failed to load";
  });
}

function renderDates(id, list, cls){
  const box = document.getElementById(id);

  if(!list || !list.length){
    box.innerHTML = "<i>No records</i>";
    return;
  }

  box.innerHTML = list
    .map(d => `<span class="dateChip ${cls}">${prettyDate(d)}</span>`)
    .join("");
}
function makeList(t){
  return t.split("\n").filter(Boolean).map(x=>`<li>${x}</li>`).join("");
}

function logout(){
  if(!confirm("Are you sure you want to logout?")) return;
  logoutOverlay.style.display="flex";
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"logout",token})})
  .finally(()=>{
    sessionStorage.clear();
    setTimeout(()=>location.replace("index.html"),600);
  });
}
</script>

</body>
</html>
