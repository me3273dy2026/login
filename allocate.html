<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;min-height:100vh;
  display:flex;justify-content:center;
}
.card{
  background:#fff;
  width:100%;max-width:540px;
  margin:24px 12px;padding:24px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1,h2{text-align:center}
.infoBox{
  background:#f5f7fa;
  padding:14px;border-radius:12px;margin-top:14px
}
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
  font-weight:700;
}
.GD{background:#e3f2fd;color:#0d47a1}
.SEMINAR{background:#e8f5e9;color:#1b5e20}
.PI{background:#fff3e0;color:#e65100}
.past{opacity:.7}
button{
  width:100%;padding:12px;margin-top:12px;
  border:none;border-radius:30px;
  font-size:15px;font-weight:600;cursor:pointer
}
button:disabled{background:#999}
.btn-main{background:#203a43;color:#fff}
.btn-logout{background:#c0392b;color:#fff}
.loading{text-align:center;font-weight:600}
</style>
</head>

<body>

<div class="card">

<h1 id="welcome"></h1>
<h2>Evaluation Schedule & Feedback</h2>

<div id="loadingBox" class="infoBox loading">
  Loading your details…
</div>

<div id="upcomingBox" class="infoBox" style="display:none"></div>
<div id="pastBox" class="infoBox" style="display:none"></div>

<button id="perfBtn" class="btn-main" onclick="togglePerf()">
  View Performance Feedback
</button>

<div id="perfPanel" class="infoBox" style="display:none">
  <button onclick="loadPerf('GD')">Group Discussion</button>
  <div id="GD"></div>

  <button onclick="loadPerf('SEMINAR')">Seminar</button>
  <div id="SEMINAR"></div>

  <button onclick="loadPerf('PI')">Personal Interview</button>
  <div id="PI"></div>
</div>

<button class="btn-logout" onclick="logout()">Logout</button>

</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec";
const token = new URLSearchParams(location.search).get("token");

/* INIT */
loadDashboard();

/* DASHBOARD */
function loadDashboard(){

  Promise.all([
    fetch(BACKEND,{
      method:"POST",
      body:new URLSearchParams({action:"dashboard",token})
    }).then(r=>r.json()),

    fetch(BACKEND,{
      method:"POST",
      body:new URLSearchParams({action:"getMyAllAllocations",token})
    }).then(r=>r.json())
  ])
  .then(([dash,alloc])=>{

    loadingBox.style.display="none";
    welcome.innerText=`Welcome ${dash.name} (${dash.roll})`;

    /* UPCOMING */
    if(alloc.upcoming.length){
      upcomingBox.innerHTML =
        `<b>Upcoming Evaluations</b><ul>` +
        alloc.upcoming.map(a=>
          `<li><span class="badge ${a.category}">
            ${a.category}</span> – ${a.date}</li>`
        ).join("") + `</ul>`;
      upcomingBox.style.display="block";
    }

    /* PAST */
    if(alloc.past.length){
      pastBox.innerHTML =
        `<b>Past Evaluations</b><ul>` +
        alloc.past.map(a=>
          `<li class="past"><span class="badge ${a.category}">
            ${a.category}</span> – ${a.date}</li>`
        ).join("") + `</ul>`;
      pastBox.style.display="block";
    }
  });
}

/* PERFORMANCE */
function togglePerf(){
  perfPanel.style.display =
    perfPanel.style.display==="none" ? "block" : "none";
}

function loadPerf(type){

  const box=document.getElementById(type);
  if(box.innerHTML){ box.innerHTML=""; return; }

  box.innerHTML="<div class='loading'>Loading…</div>";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getMyPerformance",
      token,
      type
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status!=="FOUND"){
      box.innerHTML="<b>Not yet evaluated.</b>";
      return;
    }
    box.innerHTML = `
      <div><b>Date:</b> ${res.evaluationDate}</div>
      <div><b>Marks:</b> ${res.marks} / 100</div>
      <b>Positives</b>
      <ol>${res.positives.split("\n").map(x=>`<li>${x}</li>`).join("")}</ol>
      <b>Points to Improve</b>
      <ol>${res.improvements.split("\n").map(x=>`<li>${x}</li>`).join("")}</ol>
    `;
  });
}

/* LOGOUT */
function logout(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"logout",token})
  }).finally(()=>location.href="login.html");
}
</script>

</body>
</html>
