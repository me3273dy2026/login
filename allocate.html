<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;min-height:100vh;
  display:flex;justify-content:center;
}
.card{
  background:#fff;
  width:100%;max-width:520px;
  margin:24px 12px;padding:24px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1,h2{text-align:center}
.infoBox{background:#f5f7fa;padding:14px;border-radius:12px;margin-top:14px}
.notice{background:#e8f5e9;color:#1b5e20;font-weight:700;text-align:center}
button{
  width:100%;padding:12px;margin-top:12px;
  border:none;border-radius:30px;
  font-size:15px;font-weight:600;cursor:pointer
}
.btn-perf{background:#203a43;color:#fff}
.btn-logout{background:#c0392b;color:#fff}
.loading{text-align:center;font-weight:600}
.greenBox{background:#e8f5e9;padding:12px;border-radius:10px;margin-top:8px}
.yellowBox{background:#fffde7;padding:12px;border-radius:10px;margin-top:8px}
.marksBox{
  display:inline-block;
  padding:10px 16px;
  border-radius:8px;
  font-size:18px;
  font-weight:700;
  margin:10px auto;
}
</style>
</head>

<body>

<div class="card">

<h1 id="welcome"></h1>
<h2>ME3273</h2>

<div id="loadingBox" class="infoBox loading">
  Getting details… please wait
</div>

<div id="allocBox" class="infoBox notice" style="display:none"></div>

<button id="perfBtn" class="btn-perf" disabled onclick="togglePanel()">
  Check Your Performance
</button>

<div id="perfPanel" class="infoBox" style="display:none">
  <button onclick="toggleSection('GD')">Group Discussion</button>
  <div id="GD"></div>

  <button onclick="toggleSection('SEMINAR')">Seminar</button>
  <div id="SEMINAR"></div>

  <button onclick="toggleSection('PI')">Personal Interview</button>
  <div id="PI"></div>
</div>

<button id="logoutBtn" class="btn-logout" disabled onclick="logout()">Logout</button>

</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbyRJR4DY9LQfSLL9WZZMi_h9fb8GG5IK2WwOBc8oSs5Ct5pBAsxCvNrQO90mDJxlYGVnQ/exec";
const token=new URLSearchParams(location.search).get("token");

loadAll();

function loadAll(){
  Promise.all([
    fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"dashboard",token})}).then(r=>r.json()),
    fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyLatestAllocation",token})}).then(r=>r.json())
  ]).then(([dash,alloc])=>{
    loadingBox.style.display="none";
    welcome.innerText=`Welcome ${dash.name} (${dash.roll})`;

    allocBox.style.display="block";
    allocBox.innerText=
      alloc.status==="ALLOCATED"
      ? `You have ${alloc.category} on ${alloc.date}${alloc.topic?` (Topic: ${alloc.topic})`:""}`
      : "Allocation is under process.";

    perfBtn.disabled=false;
    logoutBtn.disabled=false;
  });
}

function togglePanel(){
  perfPanel.style.display=
    perfPanel.style.display==="none"?"block":"none";
}

function toggleSection(type){
  const box=document.getElementById(type);
  if(box.innerHTML){box.innerHTML="";return;}

  box.innerHTML="<div class='loading'>Loading…</div>";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getMyPerformance",token,type})
  }).then(r=>r.json()).then(res=>{
    if(res.status!=="FOUND"){
      box.innerHTML="<b>Not yet evaluated.</b>";
      return;
    }
    box.innerHTML=`
      <div><b>Date:</b> ${res.evaluationDate}</div>
      <div class="marksBox">Marks: ${res.marks}/100</div>
      <div class="greenBox"><b>Positives</b><ol>${makeList(res.positives)}</ol></div>
      <div class="yellowBox"><b>Improvements</b><ol>${makeList(res.improvements)}</ol></div>
    `;
  });
}

function makeList(t){
  return t.split("\n").filter(Boolean).map(x=>`<li>${x}</li>`).join("");
}

function logout(){
  if(!confirm("Logout?")) return;
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"logout",token})})
    .finally(()=>location.href="login.html");
}
</script>

</body>
</html>
