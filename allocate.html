<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Topic Allocation | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.card{
  background:#fff;
  width:100%;
  max-width:520px;
  margin:24px 12px;
  padding:24px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{
  font-size:16px;
  text-align:center;
  color:#203a43;
}
h2{
  font-size:14px;
  text-align:center;
  color:#555;
}
.infoBox{
  background:#f5f7fa;
  border-radius:12px;
  padding:14px;
  margin-top:16px;
}
.notice{
  background:#e8f5e9;
  color:#1b5e20;
  font-weight:700;
  text-align:center;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:30px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  margin-top:12px;
}
.btn-perf{background:#203a43;color:#fff;}
.btn-logout{background:#c0392b;color:#fff;}
.greenBox{background:#e8f5e9;padding:12px;border-radius:10px;margin-top:10px;}
.yellowBox{background:#fffde7;padding:12px;border-radius:10px;margin-top:10px;}
.loading{text-align:center;font-weight:600;margin-top:10px;}
ol{margin:6px 0 0 18px;}
</style>
</head>

<body>

<div class="card">

<h1 id="welcome"></h1>
<h2>Group Discussion & Seminar (ME3273)</h2>

<div id="loadingBox" class="infoBox">
  Getting details, please wait…
</div>

<div id="noticeBox" class="infoBox notice" style="display:none"></div>
<div id="resultBox" class="infoBox" style="display:none"></div>
<div id="seminarBox" class="infoBox" style="display:none"></div>

<button class="btn-perf" onclick="togglePanel()">
  Check Your Performance
</button>

<!-- PERFORMANCE PANEL -->
<div id="perfPanel" class="infoBox" style="display:none">

  <button onclick="toggleSection('GD')">Group Discussion</button>
  <div id="GD" style="display:none"></div>

  <button onclick="toggleSection('SEMINAR')">Seminar</button>
  <div id="SEMINAR" style="display:none"></div>

  <button onclick="toggleSection('PI')">Personal Interview</button>
  <div id="PI" style="display:none"></div>

</div>

<button class="btn-logout" onclick="logout()">Logout</button>

</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbxw5_pMfEPHA3u13MaShb1kFfzaqcKwdkXhbEI9tqgVuHM75-Ox7Y5uuR_9xQ2bRxIZ7Q/exec";

const token = new URLSearchParams(location.search).get("token");

loadAll();

function loadAll(){
  Promise.all([
    fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"dashboard",token})}).then(r=>r.json()),
    fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getSeminarTopic",token})}).then(r=>r.json())
  ])
  .then(([dash,sem])=>{
    loadingBox.style.display="none";
    welcome.innerText=`Welcome ${dash.name} (${dash.roll})`;

    noticeBox.innerText="Please check your evaluation feedback below.";
    noticeBox.style.display="block";

    let html=`<b>Group Topic:</b> ${dash.projectName}<br><b>Members:</b><br>`;
    dash.team.forEach((s,i)=>html+=`${i+1}. ${s.name} (${s.roll})<br>`);
    resultBox.innerHTML=html;
    resultBox.style.display="block";

    if(sem.topic){
      seminarBox.innerHTML=`<b>Seminar Topic:</b><br>"${sem.topic}"`;
      seminarBox.style.display="block";
    }
  });
}

function togglePanel(){
  perfPanel.style.display =
    perfPanel.style.display==="none" ? "block" : "none";
}

function toggleSection(type){

  const box = document.getElementById(type);

  /* If open → close */
  if(box.style.display === "block"){
    box.style.display = "none";
    box.innerHTML = "";
    return;
  }

  /* Close other sections */
  ["GD","SEMINAR","PI"].forEach(t=>{
    if(t !== type){
      document.getElementById(t).style.display="none";
      document.getElementById(t).innerHTML="";
    }
  });

  /* Open this section */
  box.style.display = "block";
  box.innerHTML = `<div class="loading">Loading… please wait</div>`;

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getMyPerformance",token,type})
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status!=="FOUND"){
      box.innerHTML=`<b>Performance not yet evaluated.</b>`;
      return;
    }

    box.innerHTML=`
      <div class="greenBox">
        <b>Positives</b>
        <ol>${makeList(res.positives)}</ol>
      </div>
      <div class="yellowBox">
        <b>Points to Improve</b>
        <ol>${makeList(res.improvements)}</ol>
      </div>
    `;
  });
}

function makeList(text){
  return text.split("\n")
    .filter(l=>l.trim()!=="")
    .map(l=>`<li>${l}</li>`).join("");
}

function logout(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"logout",token})
  })
  .finally(()=>location.href="login.html");
}
</script>

</body>
</html>
