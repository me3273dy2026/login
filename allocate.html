<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg1:#0f2027;
  --bg2:#203a43;
  --bg3:#2c5364;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI",Arial,sans-serif;
  min-height:100vh;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  display:flex;
  justify-content:center;
  padding:26px 12px 90px;
}
.card{
  background:#fff;
  width:100%;
  max-width:560px;
  border-radius:20px;
  padding:26px;
  box-shadow:0 20px 50px rgba(0,0,0,.28);
}
.header{text-align:center}
.header h1{margin:0;color:#203a43;font-size:22px}
.header h2{margin:4px 0 0;font-size:14px;color:#666}
.infoBox{
  background:#f5f7fa;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
}
.loading{text-align:center;font-weight:600;color:#555}
.upcomingBox{
  background:#fdecea;
  border:2px solid #e53935;
  color:#b71c1c;
  font-weight:700;
  text-align:center;
  padding:14px;
  border-radius:14px;
  margin-top:14px;
  animation:blink 1.5s infinite;
}
@keyframes blink{0%{opacity:1}50%{opacity:.45}100%{opacity:1}}
.pastBox{
  background:#e8f5e9;
  border:1px solid #c8e6c9;
  color:#1b5e20;
  font-weight:600;
  text-align:center;
  padding:12px;
  border-radius:14px;
  margin-top:10px;
}
button{
  width:100%;
  padding:13px;
  margin-top:14px;
  border:none;
  border-radius:30px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}
.btn-primary{
  background:linear-gradient(135deg,#2c5364,#203a43);
  color:#fff;
}
.btn-attendance{
  background:linear-gradient(135deg,#2e7d32,#1b5e20);
  color:#fff;
}
.btn-logout{
  background:linear-gradient(135deg,#e74c3c,#c0392b);
  color:#fff;
}
.section{
  margin-top:10px;
  border-radius:14px;
  overflow:hidden;
  border:1px solid #e0e0e0;
}
.section-header{
  background:#fafafa;
  padding:12px 14px;
  font-weight:700;
  cursor:pointer;
}
.section-body{padding:14px;display:none}
.section.open .section-body{display:block}
footer{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#0f2027;
  color:#cfd8dc;
  text-align:center;
  padding:10px;
  font-size:13px;
  font-weight:600;
}
</style>
</head>

<body>

<div class="card">
  <div class="header">
    <h1 id="welcome"></h1>
    <h2>ME3273 · Seminar & Group Discussion</h2>
  </div>

  <div id="attendanceBox" class="infoBox" style="display:none;text-align:center">
    Current attendance :
    <div id="attendanceValue" style="font-size:22px;font-weight:800;margin-top:6px"></div>
  </div>

  <div id="loadingBox" class="infoBox loading">Fetching your details…</div>
  <div id="upcomingBox" style="display:none"></div>

  <div id="profileBox" class="infoBox" style="display:none">
    <div><b>GD Topic:</b> <span id="gdTopic">-</span></div>
    <div style="margin-top:8px"><b>GD Group Members:</b> <div id="gdMembers">-</div></div>
    <div style="margin-top:8px"><b>Seminar Topic:</b> <span id="seminarTopic">-</span></div>
  </div>

  <div id="actionButtons" style="display:none">
    <button id="perfBtn" class="btn-primary" onclick="togglePanel()">View Performance Evaluation</button>

    <div id="perfPanel" style="display:none">
      <div class="section" onclick="toggleSection('GD')">
        <div class="section-header">Group Discussion</div>
        <div class="section-body" id="GD"></div>
      </div>
      <div class="section" onclick="toggleSection('SEMINAR')">
        <div class="section-header">Seminar</div>
        <div class="section-body" id="SEMINAR"></div>
      </div>
      <div class="section" onclick="toggleSection('PI')">
        <div class="section-header">Personal Interview</div>
        <div class="section-body" id="PI"></div>
      </div>
    </div>

    <button class="btn-attendance" onclick="toggleAttendanceDetails()">View Attendance Details</button>
    <div id="attendancePanel" style="display:none;margin-top:14px">
      <div><b>Attended:</b> <div id="attendedDates"></div></div>
      <div style="margin-top:10px"><b>Absent:</b> <div id="absentDates"></div></div>
    </div>

    <button id="logoutBtn" class="btn-logout" onclick="logout()">Logout</button>
  </div>
</div>

<footer>
  Developed by Dr. Rajesh Akula
  <div>© 2026 · IIEST Shibpur</div>
</footer>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbwS-4HBC0kj4-fRB-zpe3XgnMLHztg34Xscjq9DdhnxrOd4pECaexUeeFLlguC8UfPjbA/exec";
const token=sessionStorage.getItem("token");
if(!token){ alert("Session expired"); location.replace("index.html"); }

function prettyDate(d){
  const dt=new Date(d);
  const day=dt.getDate();
  const suf=day%10===1&&day!==11?"st":day%10===2&&day!==12?"nd":day%10===3&&day!==13?"rd":"th";
  return `${day}${suf} ${dt.toLocaleString("en",{month:"short"})} ${dt.getFullYear()}`;
}
function isToday(d){
  const t=new Date();
  return d===`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`;
}
function isAfter2PMOfDate(d){
  const cut=new Date(new Date(d).toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));
  cut.setHours(14,0,0,0);
  return new Date()>=cut;
}
function before2PMOnDate(d){
  const now=new Date(new Date().toLocaleString("en-US",{timeZone:"Asia/Kolkata"}));
  const x=new Date(d); x.setHours(0,0,0,0);
  return now.toDateString()===x.toDateString() && now.getHours()<14;
}
function canShowUpcoming(d){
  const today=new Date().toISOString().slice(0,10);
  if(d>today) return true;
  if(d===today) return new Date().getHours()<14;
  return false;
}

loadAll();
function loadAll(){
Promise.all([
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"dashboard",token})}).then(r=>r.json()),
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyUpcomingAllocation",token})}).then(r=>r.json()),
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyPastAllocations",token})}).then(r=>r.json()),
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyProfileDetails",token})}).then(r=>r.json()),
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyAttendance",token})}).then(r=>r.json())
]).then(([dash,upcoming,pastList,profile,attendance])=>{
  document.getElementById("loadingBox").style.display="none";
  document.getElementById("welcome").innerText=`Welcome ${dash.name} (${dash.roll})`;

  if(profile.status==="OK"){
    gdTopic.innerText=profile.gdTopic||"-";
    seminarTopic.innerText=profile.seminarTopic||"-";
    gdMembers.innerHTML=profile.members.map(m=>`<div>${m}</div>`).join("");
    profileBox.style.display="block";
  }

  if(attendance.status==="OK"){
    attendanceBox.style.display="block";
    attendanceValue.innerText=`${attendance.percent}%`;
  }

  let msgs=[], pastMsgs=[], hasUpcoming=false;

  if(upcoming.status==="FOUND" && canShowUpcoming(upcoming.date)){
    hasUpcoming=true;
    msgs.push(`<div class="upcomingBox">Upcoming: <b>${upcoming.category}</b><br>${prettyDate(upcoming.date)}</div>`);
  }

  if(!hasUpcoming){
    let msg="You don’t have any allocations for the coming week.";
    if(pastList.status==="OK" && pastList.allocations.length && isAfter2PMOfDate(pastList.allocations[0].date)){
      msg="Allocation for the coming week has not been done yet.";
    }
    msgs.push(`<div class="pastBox" style="background:#eef3f7">${msg}</div>`);
  }

 if(pastList.status==="OK"){
  pastList.allocations.forEach(a=>{

    const style = a.evaluated
      ? ""
      : "background:#fff9c4;border:1px solid #fdd835;color:#5d4037";

    pastMsgs.push(`
      <div class="pastBox" style="${style}">
        ${a.category} · ${prettyDate(a.date)}<br>
        <i>${a.evaluated?"Evaluation completed":"Evaluation under process"}</i>
      </div>
    `);
  });
}
  if(pastMsgs.length){
  pastMsgs.unshift(`
    <div class="infoBox"
         style="background:#eef3f7;
                font-weight:700;
                text-align:center;
                color:#203a43;">
      Completed:
    </div>
  `);
}

  upcomingBox.innerHTML = [
  ...msgs,      // upcoming / messages
  ...pastMsgs   // completed section
].join("");
  upcomingBox.style.display="block";
  actionButtons.style.display="block";
});
}

/* ===== GLOBAL FUNCTIONS ===== */
function togglePanel(){ perfPanel.style.display=perfPanel.style.display==="none"?"block":"none"; }
function toggleSection(t){
  const s=document.getElementById(t).parentElement;
  s.classList.toggle("open");
  if(document.getElementById(t).innerHTML) return;
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getMyPerformance",token,type:t})})
  .then(r=>r.json()).then(res=>{
    document.getElementById(t).innerHTML=res.status==="FOUND"?`Marks: ${res.marks}/100`:"Not yet evaluated";
  });
}
function toggleAttendanceDetails(){ attendancePanel.style.display=attendancePanel.style.display==="none"?"block":"none"; }
function logout(){ sessionStorage.clear(); location.replace("index.html"); }
</script>

</body>
</html>
