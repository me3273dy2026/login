<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Topic Allocation | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
}
.card{
  background:#fff;
  width:100%;
  max-width:520px;
  margin:24px 12px;
  padding:24px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{
  font-size:16px;
  text-align:center;
  color:#203a43;
  margin:0;
}
h2{
  font-size:14px;
  text-align:center;
  color:#555;
  margin:6px 0 14px;
}
.infoBox{
  background:#f5f7fa;
  border-radius:12px;
  padding:14px;
  margin-top:16px;
  font-size:14px;
}
.notice{
  margin-top:16px;
  padding:14px;
  border-radius:12px;
  background:#e8f5e9;
  color:#1b5e20;
  font-weight:700;
  text-align:center;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:30px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  margin-top:18px;
}
.btn-logout{
  background:#c0392b;
  color:#fff;
}
.btn-perf{
  background:#203a43;
  color:#fff;
}
button:disabled{
  background:#999;
  cursor:not-allowed;
}
.footer{
  margin:12px 0 20px;
  text-align:center;
  font-size:13px;
  color:#e0e0e0;
}

/* PERFORMANCE VIEW */
.perfBox{
  margin-top:16px;
}
.perfBtns button{
  margin-top:8px;
}
.greenBox{
  background:#e8f5e9;
  border-radius:10px;
  padding:12px;
  margin-top:12px;
}
.yellowBox{
  background:#fffde7;
  border-radius:10px;
  padding:12px;
  margin-top:12px;
}
ol{
  margin:6px 0 0 18px;
}
.loading{
  text-align:center;
  font-weight:600;
  margin-top:10px;
}
</style>
</head>

<body>

<div class="card">

  <!-- WELCOME -->
  <h1 id="welcome" style="display:none"></h1>
  <h2>Group Discussion & Seminar (ME3273)</h2>

  <!-- LOADING -->
  <div id="loadingBox" class="infoBox">
    <b>Getting details, please wait…</b>
  </div>

  <!-- FINAL CONTENT -->
  <div id="noticeBox" class="notice" style="display:none"></div>
  <div id="resultBox" class="infoBox" style="display:none"></div>
  <div id="seminarBox" class="infoBox" style="display:none"></div>

  <!-- PERFORMANCE VIEWER -->
  <button id="perfBtn" class="btn-perf" style="display:none"
          onclick="togglePerformance()">
    Check Your Performance
  </button>

  <div id="perfPanel" class="infoBox perfBox" style="display:none">

    <div class="perfBtns">
      <button onclick="loadPerformance('GD')">Group Discussion</button>
      <button onclick="loadPerformance('SEMINAR')">Seminar</button>
      <button onclick="loadPerformance('PI')">Personal Interview</button>
    </div>

    <div id="perfLoading" class="loading" style="display:none">
      Loading… please wait
    </div>

    <div id="perfContent" style="display:none">

      <div class="greenBox">
        <b>Positives</b>
        <ol id="posList"></ol>
      </div>

      <div class="yellowBox">
        <b>Points to Improve</b>
        <ol id="impList"></ol>
      </div>

    </div>
  </div>

  <button id="logoutBtn" class="btn-logout" disabled onclick="logout()">
    Logout
  </button>

</div>

<div class="footer">
  <div>Developed by Dr. Rajesh Akula</div>
  <div>© 2026 · IIEST Shibpur</div>
</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbxw5_pMfEPHA3u13MaShb1kFfzaqcKwdkXhbEI9tqgVuHM75-Ox7Y5uuR_9xQ2bRxIZ7Q/exec";

const token = new URLSearchParams(location.search).get("token");

/* ---------- LOAD DASHBOARD ---------- */
loadAll();

function loadAll(){

  const dashboardReq = fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({ action:"dashboard", token })
  }).then(r=>r.json());

  const seminarReq = fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({ action:"getSeminarTopic", token })
  }).then(r=>r.json());

  Promise.all([dashboardReq, seminarReq])
    .then(([dash, sem]) => {

      loadingBox.style.display = "none";

      welcome.style.display = "block";
      welcome.innerText = `Welcome ${dash.name} (${dash.roll})`;

      if(dash.status !== "ASSIGNED"){
        resultBox.innerHTML = "<b>No group assigned.</b>";
        resultBox.style.display = "block";
        logoutBtn.disabled = false;
        return;
      }

      /* NOTICE */
      const gdTopics = ["T1","T2","T3"];
      noticeBox.innerText = gdTopics.includes(dash.project)
        ? "You have a group discussion on 13th Jan 2026."
        : "You may have a seminar or personal interview on 13th Jan 2026.";
      noticeBox.style.display = "block";

      /* GROUP INFO */
      let html =
        `<b>Assigned Group Discussion Topic:</b><br>
         ${dash.project} – ${dash.projectName}<br><br>
         <b>Group Members:</b><br>`;

      dash.team.forEach((s,i)=>{
        html += `${i+1}. ${s.name} (${s.roll})<br>`;
      });

      resultBox.innerHTML = html;
      resultBox.style.display = "block";

      /* SEMINAR */
      if(sem.topic){
        seminarBox.innerHTML =
          `<b>Submitted Seminar Topic:</b><br>
           <span style="color:#1b5e20">"${sem.topic}"</span>`;
        seminarBox.style.display = "block";
      }

      perfBtn.style.display = "block";
      logoutBtn.disabled = false;
    });
}

/* ---------- PERFORMANCE VIEW ---------- */
function togglePerformance(){
  perfPanel.style.display =
    perfPanel.style.display === "none" ? "block" : "none";
}

function loadPerformance(type){

  perfLoading.style.display = "block";
  perfContent.style.display = "none";
  posList.innerHTML = "";
  impList.innerHTML = "";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getMyPerformance",
      token: token,
      type: type
    })
  })
  .then(r=>r.json())
  .then(res=>{
    perfLoading.style.display = "none";

    if(res.status !== "FOUND"){
      perfContent.innerHTML =
        "<b>Performance not yet evaluated.</b>";
      perfContent.style.display = "block";
      return;
    }

    renderList(posList, res.positives);
    renderList(impList, res.improvements);

    perfContent.style.display = "block";
  });
}

function renderList(el, text){
  el.innerHTML = "";
  text.split("\n")
    .map(l=>l.trim())
    .filter(l=>l!=="")
    .forEach(line=>{
      const li=document.createElement("li");
      li.innerText=line;
      el.appendChild(li);
    });
}

/* ---------- LOGOUT ---------- */
function logout(){
  logoutBtn.disabled = true;
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({ action:"logout", token })
  })
  .finally(()=>location.href="login.html");
}
</script>

</body>
</html>
