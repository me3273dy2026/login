<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  margin:0;
  display:flex;
  justify-content:center;
}
.card{
  background:#fff;
  width:100%;
  max-width:1200px;
  margin:24px 12px;
  padding:28px;
  border-radius:14px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}

h1{text-align:center;color:#e67e22;margin-bottom:6px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:22px;}

button{
  width:100%;
  padding:14px;
  margin-top:14px;
  border:none;
  border-radius:30px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}
button:disabled{
  background:#999;
  cursor:not-allowed;
  opacity:0.6;
}

.btn-main{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;}
.btn-red{background:#c0392b;color:#fff;}
.btn-close{background:#7f8c8d;color:#fff;}

.section{display:none;margin-top:24px;}

label{font-weight:600;margin-top:12px;display:block;}
select,input,textarea{
  width:100%;
  padding:10px 12px;
  margin-top:6px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:15px;
}
textarea{min-height:90px;}

.row{display:flex;gap:16px;margin-top:18px;}
.box{
  flex:1;
  background:#f8f9fa;
  padding:16px;
  border-radius:12px;
}
.box h3{
  margin-top:0;
  color:#203a43;
  border-bottom:1px solid #ddd;
  padding-bottom:6px;
}

.sub{background:#fff;padding:10px;border-radius:8px;margin-top:8px;}
.loading{text-align:center;font-weight:600;margin-top:14px;}

.footer{
  margin-top:32px;
  text-align:center;
  font-size:13px;
  color:#5f6f78;
  font-weight:600;
}
.footer div{font-size:12px;color:#7a8a93;}

@media(max-width:900px){.row{flex-direction:column;}}
  /* ===== LOADER ===== */
#loaderOverlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.85);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:9999;
}

.spinner{
  width:48px;
  height:48px;
  border:5px solid #ddd;
  border-top:5px solid #e67e22;
  border-radius:50%;
  animation:spin 1s linear infinite;
}

.loader-text{
  margin-top:12px;
  font-weight:600;
  color:#203a43;
}

@keyframes spin{
  to{transform:rotate(360deg);}
}
</style>
</head>

<body>
<div class="card">

<h1>Faculty Dashboard</h1>
<h2>ME3273 Â· GD Â· Seminar Â· PI</h2>

<!-- ================= HOME ================= -->
<div id="home">
  <button class="btn-main" onclick="openAllocate()">Allocate Students</button>
  <button class="btn-main" onclick="openEvaluate()">Evaluate Students</button>
  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<!-- ================= ALLOCATION ================= -->
<div id="allocate" class="section">

  <h2>Student Allocation</h2>

  <label>Date</label>
  <input type="date" id="date" onchange="onDate()">
  <div id="dateStatus" class="loading"></div>

  <div class="box">
    <h3>Group Discussion</h3>
    <div id="gdExisting" class="sub"></div>
    <button id="gdOpenBtn" class="btn-main" disabled onclick="loadGD()">Allocate / Update GD</button>
    <div id="gdBox" class="sub" style="display:none"></div>
    <button id="saveGDBtn" class="btn-main" style="display:none" onclick="saveGD()">Save GD</button>
  </div>

  <div class="box">
    <h3>Seminar</h3>
    <div id="semExisting" class="sub"></div>
    <button id="semOpenBtn" class="btn-main" disabled onclick="loadSeminar()">Allocate / Update Seminar</button>
    <div id="semBox" class="sub" style="display:none"></div>
    <button id="saveSemBtn" class="btn-main" style="display:none" onclick="saveSeminar()">Save Seminar</button>
  </div>

  <div class="box">
    <h3>Personal Interview</h3>
    <div id="piExisting" class="sub"></div>
    <button id="piOpenBtn" class="btn-main" disabled onclick="loadPI()">Allocate / Update PI</button>
    <div id="piBox" class="sub" style="display:none"></div>
    <button id="savePIBtn" class="btn-main" style="display:none" onclick="savePI()">Save PI</button>
  </div>

  <button class="btn-close" onclick="closeSection()">Close</button>
</div>

<!-- ================= EVALUATION ================= -->
<div id="evaluate" class="section">
  <h2>Evaluate Students</h2>

  <label>Select Student</label>
  <select id="studentSelect" onchange="loadStudentDetails()">
    <option value="">Loadingâ€¦</option>
  </select>

  <div class="row">
    <div class="box">
      <h3>Student Details</h3>
      <div id="studentInfo"></div>

      <h3>Seminar Topic</h3>
      <div id="seminarInfo"></div>
    </div>

    <div class="box">
      <h3>Evaluation</h3>

      <label>Type</label>
      <select id="typeSelect" onchange="loadLatestPerformance()">
        <option value="GD">GD</option>
        <option value="SEMINAR">Seminar</option>
        <option value="PI">PI</option>
      </select>

      <label>Marks</label>
      <input type="number" id="marks" min="0" max="100">

      <label>Positives</label>
      <textarea id="positives"></textarea>

      <label>Improvements</label>
      <textarea id="improvements"></textarea>

      <button class="btn-main" onclick="saveEvaluation()">Save Evaluation</button>
    </div>
  </div>

  <button class="btn-close" onclick="closeSection()">Close</button>
</div>
<!-- ===== GLOBAL LOADER ===== -->
<div id="loaderOverlay" style="display:none;">
  <div class="spinner"></div>
  <div class="loader-text">Loadingâ€¦ Please wait</div>
</div>
<div class="footer">
  Developed by Dr. Rajesh Akula
  <div>Â© 2026 Â· IIEST Shibpur</div>
</div>

</div>

<script>
/* ================= NAVIGATION ================= */
function openAllocate(){
 home.style.display = "none";
  evaluate.style.display = "none";
  allocate.style.display = "block";

  // Reset allocation state
  allocStage = 0;

  date.disabled = false;
  date.value = "";

  dateStatus.innerText = "";

  gdOpenBtn.disabled = true;
  semOpenBtn.disabled = true;
  piOpenBtn.disabled = true;

  saveGDBtn.style.display = "none";
  saveSemBtn.style.display = "none";
  savePIBtn.style.display = "none";

  gdBox.style.display = "none";
  semBox.style.display = "none";
  piBox.style.display = "none";
}
function openEvaluate(){
  home.style.display="none";
  allocate.style.display="none";
  evaluate.style.display="block";
  loadStudents();
}
function closeSection(){
  allocate.style.display="none";
  evaluate.style.display="none";
  home.style.display="block";
}
function logout(){
  showLoader("Logging outâ€¦");
  setTimeout(()=>{
    location.href="login.html";
  },600);
}

/* ================= STATE ================= */
let allocStage = 0;
// 0=init, 1=dateSelected, 2=gdDone, 3=semDone

function updateAllocationButtons(){
 gdOpenBtn.disabled = true;
  semOpenBtn.disabled = true;
  piOpenBtn.disabled = true;

  if(allocStage === 1 && date.value){
    gdOpenBtn.disabled = false;
  }
  else if(allocStage === 2){
    semOpenBtn.disabled = false;
  }
  else if(allocStage === 3){
    piOpenBtn.disabled = false;
  }
}

/* ================= CONFIG ================= */
const BACKEND="https://script.google.com/macros/s/AKfycbwH0F4r_DSEzhfAKljTr_fXA8loxjaBqtgCu85lKt-01mbkMTyV2hMmvp6VsNH3v4VRxw/exec";

/* ================= UI HELPERS ================= */
function disableAllButtons(){
  document.querySelectorAll("button").forEach(b=>{
    if(!b.classList.contains("btn-red") && !b.classList.contains("btn-close")){
      b.disabled=true;
    }
  });
}
  /* ===== LOADER HELPERS ===== */
function showLoader(text="Loadingâ€¦ Please wait"){
  document.getElementById("loaderOverlay").style.display="flex";
  document.querySelector(".loader-text").innerText = text;
}
function hideLoader(){
  document.getElementById("loaderOverlay").style.display="none";
}
function setLoading(btn,text){
  btn.dataset.originalText = btn.innerText;
  btn.innerText = text;
}
function resetButton(btn){
  btn.innerText = btn.dataset.originalText;
}

/* ================= DATE ================= */
async function onDate(){
  allocStage = 1;

  dateStatus.innerText = "Loadingâ€¦ Please wait";

  gdBox.style.display="none";
  semBox.style.display="none";
  piBox.style.display="none";
  saveGDBtn.style.display="none";
  saveSemBtn.style.display="none";
  savePIBtn.style.display="none";

  await loadExisting();   // wait for async work

  dateStatus.innerText = "";

  updateAllocationButtons(); // âœ… ENABLE GD NOW
}

/* ================= LOAD EXISTING ================= */
async function loadExisting(){
  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getAllocationsByDate",date:date.value})
  }).then(r=>r.json());

  const gd=[], sem=[], pi=[];
  res.allocations.forEach(a=>{
    if(a.category==="GD") gd.push(a);
    if(a.category==="SEMINAR") sem.push(a);
    if(a.category==="PI") pi.push(a);
  });

  const uniqGD = {};
gd.forEach(x => uniqGD[x.roll] = x);

gdExisting.innerHTML = Object.values(uniqGD).length
  ? Object.values(uniqGD)
      .map(x => `${x.name} (${x.roll}) [${x.topic}]`)
      .join("<br>")
  : "<i>No GD</i>";

const uniqSem = {};
sem.forEach(x => uniqSem[x.roll] = x);

semExisting.innerHTML = Object.values(uniqSem).length
  ? Object.values(uniqSem)
      .map(x => `${x.name} (${x.roll})`)
      .join("<br>")
  : "<i>No Seminar</i>";
  
const uniqPI = {};
pi.forEach(x => uniqPI[x.roll] = x);

piExisting.innerHTML = Object.values(uniqPI).length
  ? Object.values(uniqPI)
      .map(x => `${x.name} (${x.roll})`)
      .join("<br>")
  : "<i>No PI</i>";
}

/* ================= GD / SEMINAR / PI ================= */
/* ================= GD ================= */
async function loadGD(){

  // Lock date
  date.disabled = true;

  // Disable other allocation buttons
  semOpenBtn.disabled = true;
  piOpenBtn.disabled = true;

  // Visual feedback
  setLoading(gdOpenBtn,"Loadingâ€¦ Please wait");

  // Hide open button, show editor
  gdOpenBtn.style.display="none";
  gdBox.style.display="block";
  saveGDBtn.style.display="block";
  gdBox.innerHTML="";

  // Disable everything else safely
  disableAllButtons();

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getGDTopicStatus",
      date:date.value
    })
  }).then(r=>r.json());

  res.topics.forEach(t=>{
    gdBox.innerHTML += `
      <label>
        <input type="checkbox" value="${t.topic}" ${t.checked?"checked":""}>
        ${t.topic}
      </label><br>`;
  });

  resetButton(gdOpenBtn);
  saveGDBtn.disabled=false;
}

async function saveGD(){
  disableAllButtons();
  setLoading(saveGDBtn,"Updatingâ€¦ Please wait");

  const topics=[...gdBox.querySelectorAll("input:checked")].map(i=>i.value);

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      date:date.value,
      topics:topics.join(",")
    })
  });

  gdBox.style.display="none";
  saveGDBtn.style.display="none";

  gdOpenBtn.style.display="block";
  gdOpenBtn.disabled=true;

  await loadExisting();

  allocStage = 2;
  resetButton(saveGDBtn);
  updateAllocationButtons();
}

/* ================= SEMINAR ================= */
async function loadSeminar(){

  setLoading(semOpenBtn,"Loadingâ€¦ Please wait");

  semOpenBtn.style.display="none";
  semBox.style.display="block";
  saveSemBtn.style.display="block";
  semBox.innerHTML="";

  disableAllButtons();

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getSeminarStudentStatus",
      date:date.value
    })
  }).then(r=>r.json());

  res.students.forEach(s=>{
    semBox.innerHTML += `
      <label>
        <input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}>
        ${s.name}
      </label><br>`;
  });

  resetButton(semOpenBtn);
  saveSemBtn.disabled=false;
}

async function saveSeminar(){
  disableAllButtons();
  setLoading(saveSemBtn,"Updatingâ€¦ Please wait");

  const rolls=[...semBox.querySelectorAll("input:checked")].map(i=>i.value);

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"SEMINAR",
      date:date.value,
      rolls:rolls.join(",")
    })
  });

  semBox.style.display="none";
  saveSemBtn.style.display="none";

  semOpenBtn.style.display="block";
  semOpenBtn.disabled=true;

  await loadExisting();

  allocStage = 3;
  resetButton(saveSemBtn);
  updateAllocationButtons();
}

/* ================= PI ================= */
async function loadPI(){

  setLoading(piOpenBtn,"Loadingâ€¦ Please wait");

  piOpenBtn.style.display="none";
  piBox.style.display="block";
  savePIBtn.style.display="block";
  piBox.innerHTML="";

  disableAllButtons();

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getPIStudentStatus",
      date:date.value
    })
  }).then(r=>r.json());

  res.students.forEach(s=>{
    piBox.innerHTML += `
      <label>
        <input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}>
        ${s.name}
      </label><br>`;
  });

  resetButton(piOpenBtn);
  savePIBtn.disabled=false;
}

async function savePI(){
  disableAllButtons();
  setLoading(savePIBtn,"Updatingâ€¦ Please wait");

  const rolls=[...piBox.querySelectorAll("input:checked")].map(i=>i.value);

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"PI",
      date:date.value,
      rolls:rolls.join(",")
    })
  });

  piBox.style.display="none";
  savePIBtn.style.display="none";

  piOpenBtn.style.display="block";
  piOpenBtn.disabled=true;

  await loadExisting();

  // ðŸ” Reset cycle
  allocStage = 1;
  date.disabled = false;

  resetButton(savePIBtn);
  updateAllocationButtons();
}

/* ================= EVALUATION ================= */
function loadStudents(){
  fetch(BACKEND+"?action=getAllStudents")
  .then(r=>r.json())
  .then(res=>{
    studentSelect.innerHTML='<option value="">Select Student</option>';
    res.students.forEach(s=>{
      studentSelect.innerHTML+=`<option value="${s.roll}">${s.roll} â€“ ${s.name}</option>`;
    });
  });
}

function loadStudentDetails(){
  const roll = studentSelect.value;
  if(!roll) return;

  showLoader("Fetching student detailsâ€¦");

  Promise.all([
    fetch(BACKEND+"?action=getStudentDetailsByRoll&roll="+roll).then(r=>r.json()),
    fetch(BACKEND+"?action=getLatestPerformance&roll="+roll+"&type="+typeSelect.value).then(r=>r.json())
  ]).then(([d, p])=>{

    studentInfo.innerHTML = `<b>${d.name}</b><br>${d.roll}`;
    seminarInfo.innerText = d.seminarTopic || "-";

    if(p.status==="FOUND"){
      marks.value = p.marks;
      positives.value = p.positives;
      improvements.value = p.improvements;
    }else{
      marks.value = "";
      positives.value = "";
      improvements.value = "";
    }

  }).finally(()=>{
    hideLoader();
  });
}

function loadLatestPerformance(){
  const roll=studentSelect.value;
  const type=typeSelect.value;
  if(!roll) return;

  fetch(BACKEND+"?action=getLatestPerformance&roll="+roll+"&type="+type)
  .then(r=>r.json())
  .then(d=>{
    if(d.status==="FOUND"){
      marks.value=d.marks;
      positives.value=d.positives;
      improvements.value=d.improvements;
    }else{
      marks.value="";
      positives.value="";
      improvements.value="";
    }
  });
}

function saveEvaluation(){
  if(!studentSelect.value){
    alert("Please select a student");
    return;
  }

  showLoader("Saving evaluationâ€¦");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"savePerformance",
      roll:studentSelect.value,
      type:typeSelect.value,
      marks:marks.value,
      positives:positives.value,
      improvements:improvements.value
    })
  })
  .then(()=>alert("Evaluation saved successfully"))
  .finally(()=>{
    hideLoader();
  });
}
</script>

</body>
</html>
