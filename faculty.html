<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;margin:0;
  display:flex;justify-content:center;
}
.card{
  background:#fff;
  width:100%;max-width:1100px;
  margin:24px 12px;
  padding:28px;
  border-radius:18px;
  box-shadow:0 20px 45px rgba(0,0,0,.28);
}
h1{text-align:center;color:#e67e22;margin-bottom:4px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:24px;}

.section{display:none;margin-top:20px;}
.box{
  background:#f4f7fb;
  padding:18px;
  border-radius:14px;
  margin-top:18px;
}

.label{
  font-weight:700;
  color:#2c3e50;
  margin-bottom:6px;
  display:block;
}

.input-wrap{
  display:flex;
  gap:12px;
  margin-top:8px;
}

input[type="date"], select{
  flex:1;
  padding:12px 14px;
  border-radius:10px;
  border:1px solid #ccd6dd;
  font-size:14px;
  background:#fff;
}

button{
  width:100%;
  padding:12px;
  margin-top:14px;
  border:none;
  border-radius:28px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
}

.btn-main{background:#203a43;color:#fff;}
.btn-alloc{background:#27ae60;color:#fff;}
.btn-eval{background:#2980b9;color:#fff;}
.btn-close{background:#7f8c8d;color:#fff;}
.btn-logout{background:#c0392b;color:#fff;}

.sublist{
  background:#fff;
  border-radius:10px;
  padding:12px;
  margin-top:10px;
  font-size:14px;
}

.loading{text-align:center;font-weight:700;}
ul{margin-left:18px;}

.footer{
  margin-top:30px;
  text-align:center;
  font-size:13px;
  color:#5f6f78;
}
</style>
</head>

<body>
<div class="card">

<h1>Faculty Dashboard</h1>
<h2>ME3273 · Weekly Allocation</h2>

<div id="home">
  <button class="btn-alloc" onclick="openAllocate()">Allocate Students</button>
  <button class="btn-eval" onclick="openEvaluate()">Evaluate Students</button>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<div id="allocate" class="section">

<div class="box">
  <label class="label">Allocation Date</label>
  <input type="date" id="allocDate" onchange="resetAll()">
</div>

<!-- GD -->
<div class="box">
  <h3>Group Discussion (<span id="gdDate"></span>)</h3>

  <div class="input-wrap">
    <select id="gdTopic">
      <option value="">Select / Update GD Topic</option>
      <option>T1</option><option>T2</option><option>T3</option>
      <option>T4</option><option>T5</option><option>T6</option>
      <option>T7</option><option>T8</option><option>T9</option>
    </select>
  </div>

  <button class="btn-main" onclick="allocateGD()">Allocate GD</button>

  <div id="gdExisting" class="sublist"></div>
</div>

<!-- SEMINAR -->
<div class="box">
  <h3>Seminar (<span id="semDate"></span>)</h3>
  <div id="seminarExisting" class="sublist"></div>
  <div id="seminarList"></div>
  <button class="btn-main" onclick="saveSeminar()">Save Seminar Allocation</button>
</div>

<!-- PI -->
<div class="box">
  <h3>Personal Interview (<span id="piDate"></span>)</h3>
  <div id="piExisting" class="sublist"></div>
  <div id="piList"></div>
  <button class="btn-main" onclick="savePI()">Save PI Allocation</button>
</div>

<button class="btn-close" onclick="closeAll()">Close</button>
</div>

<div id="evaluate" class="section">
  <iframe src="faculty_evaluation.html"
    style="width:100%;height:700px;border:none;border-radius:14px"></iframe>
  <button class="btn-close" onclick="closeAll()">Close</button>
</div>

<div class="footer">
  Developed by Dr. Rajesh Akula<br>© 2026 · IIEST Shibpur
</div>

</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbxbb1jVd5GSYDmH9HJ7_zadV5n9Q4NqTOFEA0ZalZY3_IJvVCgEt-a5GVICSbfgFHHNYg/exec";

function openAllocate(){home.style.display="none";allocate.style.display="block";}
function openEvaluate(){home.style.display="none";evaluate.style.display="block";}
function closeAll(){allocate.style.display="none";evaluate.style.display="none";home.style.display="block";}

function resetAll(){
  gdDate.textContent=semDate.textContent=piDate.textContent=allocDate.value;
  gdExisting.innerHTML=seminarExisting.innerHTML=piExisting.innerHTML="";
  seminarList.innerHTML=piList.innerHTML="";
  loadAllocations();
}

function loadAllocations(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getAllocationsByDate",date:allocDate.value})
  }).then(r=>r.json()).then(res=>{
    const g={GD:[],SEMINAR:[],PI:[]};
    res.allocations.forEach(a=>g[a.category].push(a));

    gdExisting.innerHTML=g.GD.length
      ? "<ul>"+g.GD.map(x=>`<li>${x.roll} – ${x.name} <b>[${x.topic}]</b></li>`).join("")+"</ul>"
      : "<i>No GD</i>";

    seminarExisting.innerHTML=g.SEMINAR.length
      ? "<ul>"+g.SEMINAR.map(x=>`<li>${x.roll} – ${x.name}</li>`).join("")+"</ul>"
      : "<i>No Seminar</i>";

    piExisting.innerHTML=g.PI.length
      ? "<ul>"+g.PI.map(x=>`<li>${x.roll} – ${x.name}</li>`).join("")+"</ul>"
      : "<i>No PI</i>";
  });
}

function allocateGD(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      date:allocDate.value,
      topic:gdTopic.value
    })
  }).then(()=>{loadAllocations();loadSeminarEligible();});
}

function loadSeminarEligible(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligibleSeminar",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    seminarList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}"> ${s.roll} – ${s.name}</label><br>`
    ).join("")||"<i>No eligible students</i>";
  });
}

function saveSeminar(){
  save("SEMINAR","seminarList",()=>{loadAllocations();loadPIEligible();});
}

function loadPIEligible(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligiblePI",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    piList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}"> ${s.roll} – ${s.name}</label><br>`
    ).join("")||"<i>No eligible students</i>";
  });
}

function savePI(){save("PI","piList",loadAllocations);}

function save(cat,id,cb){
  const rolls=[...document.querySelectorAll(`#${id} input:checked`)].map(i=>i.value);
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:cat,
      date:allocDate.value,
      rolls:rolls.join(",")
    })
  }).then(cb);
}

function logout(){location.href="login.html";}
</script>
</body>
</html>
