<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;margin:0;
  display:flex;justify-content:center;align-items:flex-start;
}
.card{
  background:#fff;
  width:100%;max-width:1100px;
  margin:24px 12px;
  padding:28px;
  border-radius:14px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{text-align:center;color:#e67e22;margin-bottom:4px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:18px;}

select,input,textarea,button{
  width:100%;padding:10px 12px;
  border-radius:6px;border:1px solid #ccc;
  font-size:15px;margin-top:6px;
}
textarea{min-height:90px;resize:vertical;}

button{
  background:linear-gradient(135deg,#f39c12,#e67e22);
  color:#fff;border:none;font-weight:600;
  border-radius:30px;margin-top:12px;cursor:pointer;
}
.logout-btn{
  background:linear-gradient(135deg,#c0392b,#a93226);
}

.row{display:flex;gap:16px;margin-top:18px;}
.box{
  flex:1;background:#f8f9fa;
  padding:16px;border-radius:12px;
}
.box h3{
  margin-top:0;color:#203a43;
  border-bottom:1px solid #ddd;padding-bottom:6px;
}

.loading{text-align:center;font-weight:600;color:#555;margin-top:16px;}

.preview{
  background:#fff;border:1px dashed #ccc;
  border-radius:6px;padding:10px 12px;margin-top:6px;
}
.preview ol{margin:0;padding-left:18px;}

.section{margin-top:28px;}
.checkbox-list label{display:block;margin-top:6px;}

.footer{
  margin-top:22px;text-align:center;
  font-size:13px;color:#5f6f78;font-weight:600;
}
.footer div{font-size:12px;color:#7a8a93;}

@media(max-width:900px){
  .row{flex-direction:column;}
}
</style>
</head>

<body>

<div class="card">

<h1>Faculty Dashboard</h1>
<h2>Evaluation & Weekly Allocation (ME3273)</h2>

<!-- COMMON DATE -->
<label>Evaluation Date (GD / Seminar / PI)</label>
<input type="date" id="allocDate">

<!-- ================= PERFORMANCE EVALUATION ================= -->
<div class="section">
<h3 style="color:#203a43">Student Performance Evaluation</h3>

<label>Select Student</label>
<select id="studentSelect">
  <option>Loading students…</option>
</select>

<div id="loading" class="loading" style="display:none">
  Loading… please wait
</div>

<div id="content" style="display:none">
  <div class="row">

    <!-- LEFT -->
    <div class="box">
      <h3>Student Details</h3>
      <div id="studentInfo"></div>

      <h3 style="margin-top:16px">Group Discussion</h3>
      <div id="gdInfo"></div>

      <h3 style="margin-top:16px">Seminar Topic</h3>
      <div id="seminarInfo"></div>
    </div>

    <!-- RIGHT -->
    <div class="box">
      <h3>Evaluation</h3>

      <label>Evaluation Type</label>
      <select id="typeSelect">
        <option value="GD">Group Discussion</option>
        <option value="SEMINAR">Seminar</option>
        <option value="PI">Personal Interview</option>
      </select>

      <label>Marks (0–100)</label>
      <input type="number" id="marks" min="0" max="100">

      <label>Positives (one per line)</label>
      <textarea id="positives"
        oninput="renderBullets('positives','posPreview')"></textarea>
      <div id="posPreview" class="preview"></div>

      <label>Points to Improve (one per line)</label>
      <textarea id="improvements"
        oninput="renderBullets('improvements','impPreview')"></textarea>
      <div id="impPreview" class="preview"></div>

      <div id="actionArea" class="loading">
        Loading… please wait
      </div>
    </div>

  </div>
</div>
</div>

<!-- ================= WEEKLY ALLOCATION ================= -->
<div class="section">
<h3 style="color:#203a43">Weekly Allocation</h3>

<!-- GD -->
<div class="box">
<h3>Group Discussion (Topics)</h3>
<select id="gdTopic">
  <option value="">Select Topic</option>
  <option>T1</option><option>T2</option><option>T3</option>
  <option>T4</option><option>T5</option><option>T6</option>
  <option>T7</option><option>T8</option><option>T9</option>
</select>
<button onclick="saveGD()">Allocate GD</button>
</div>

<!-- SEMINAR -->
<div class="box section">
<h3>Seminar Allocation</h3>
<button onclick="loadSeminar()">Load Eligible Students</button>
<div id="seminarList" class="checkbox-list"></div>
<button onclick="saveSeminar()">Save Seminar Allocation</button>
</div>

<!-- PI -->
<div class="box section">
<h3>Personal Interview Allocation</h3>
<button onclick="loadPI()">Load Eligible Students</button>
<div id="piList" class="checkbox-list"></div>
<button onclick="savePI()">Save PI Allocation</button>
</div>

<!-- PDF -->
<div class="box section">
<h3>Export Allocation</h3>
<button onclick="exportPDF()">Download Allocation PDF</button>
</div>

<button class="logout-btn" onclick="logoutFaculty()">Logout</button>

<div class="footer">
Developed by Dr. Rajesh Akula
<div>© 2026 · IIEST Shibpur</div>
</div>

</div>

<script>
/* ===== ACCESS GUARD ===== */
if(sessionStorage.getItem("facultyLoggedIn")!=="YES"){
  location.replace("login.html");
}

const BACKEND =
"https://script.google.com/macros/s/AKfycbzswNMJiLFid26BCqXp-ShajqAF_ReSHSjaT3fptFUHlB9h7mhiWCq59l72tvyBUYRslg/exec";

/* ---------- LOAD STUDENTS ---------- */
fetch(BACKEND+"?action=getAllStudents")
.then(r=>r.json())
.then(res=>{
  studentSelect.innerHTML='<option value="">Select Student</option>';
  res.students.forEach(s=>{
    studentSelect.innerHTML+=
      `<option value="${s.roll}">${s.roll} – ${s.name}</option>`;
  });
});

studentSelect.onchange=loadStudent;
typeSelect.onchange=loadPerformance;

/* ---------- STUDENT DETAILS ---------- */
function loadStudent(){
  if(!studentSelect.value) return;
  loading.style.display="block";
  content.style.display="none";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getStudentDetailsByRoll",
      roll:studentSelect.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    studentInfo.innerHTML=
      `<b>Name:</b> ${d.name}<br><b>Roll:</b> ${d.roll}`;

    gdInfo.innerHTML=d.project
      ? `<b>Topic:</b> ${d.projectName}
         <ul>${d.team.map(t=>`<li>${t.name} (${t.roll})</li>`).join("")}</ul>`
      : "Not assigned";

    seminarInfo.innerHTML=d.seminarTopic||"Not submitted";

    loading.style.display="none";
    content.style.display="block";
    loadPerformance();
  });
}

/* ---------- PERFORMANCE ---------- */
function loadPerformance(){
  actionArea.innerHTML="Loading… please wait";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getLatestPerformance",
      roll:studentSelect.value,
      type:typeSelect.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    positives.value=res.status==="FOUND"?res.positives:"";
    improvements.value=res.status==="FOUND"?res.improvements:"";
    marks.value=res.status==="FOUND"?res.marks:"";

    renderBullets("positives","posPreview");
    renderBullets("improvements","impPreview");

    actionArea.innerHTML=
      `<button onclick="savePerformance()">
        ${res.status==="FOUND"?"Update":"Save"} Performance
      </button>`;
  });
}

function savePerformance(){
  const btn=document.querySelector("#actionArea button");
  btn.disabled=true; btn.innerText="Updating…";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"savePerformance",
      roll:studentSelect.value,
      type:typeSelect.value,
      marks:marks.value,
      positives:positives.value,
      improvements:improvements.value
    })
  })
  .then(()=>{ btn.disabled=false; btn.innerText="Update Performance"; });
}

/* ---------- BULLETS ---------- */
function renderBullets(tid,pid){
  const lines=document.getElementById(tid).value
    .split("\n").map(l=>l.trim()).filter(Boolean)
    .map(l=>l.charAt(0).toUpperCase()+l.slice(1));
  document.getElementById(pid).innerHTML=
    lines.length?`<ol>${lines.map(l=>`<li>${l}</li>`).join("")}</ol>`:"";
}

/* ---------- ALLOCATION ---------- */
function saveGD(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      topic:gdTopic.value,
      date:allocDate.value
    })
  }).then(()=>alert("GD allocated"));
}

function loadSeminar(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligibleSeminar",
      date:allocDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    seminarList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}">
      ${s.roll} – ${s.name}</label>`
    ).join("");
  });
}

function saveSeminar(){
  const rolls=[...seminarList.querySelectorAll("input:checked")]
    .map(i=>i.value).join(",");
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"SEMINAR",
      date:allocDate.value,
      rolls
    })
  }).then(()=>alert("Seminar allocated"));
}

function loadPI(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligiblePI",
      date:allocDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    piList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}">
      ${s.roll} – ${s.name}</label>`
    ).join("");
  });
}

function savePI(){
  const rolls=[...piList.querySelectorAll("input:checked")]
    .map(i=>i.value).join(",");
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"PI",
      date:allocDate.value,
      rolls
    })
  }).then(()=>alert("PI allocated"));
}

function exportPDF(){
  window.open(
    BACKEND+"?action=exportAllocationPDF&date="+allocDate.value,
    "_blank"
  );
}

function logoutFaculty(){
  if(confirm("Logout?")){
    sessionStorage.removeItem("facultyLoggedIn");
    location.href="login.html";
  }
}
</script>

</body>
</html>
