<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
*{box-sizing:border-box}
body{font-family:Segoe UI,Arial,sans-serif;background:#203a43;margin:0;padding:10px}
.card{max-width:1100px;margin:auto;background:#fff;padding:16px;border-radius:14px}
button{width:100%;padding:14px;margin-top:10px;border:none;border-radius:28px;font-weight:600;cursor:pointer}
button:disabled{background:#aaa}
.btn{background:#203a43;color:#fff}
.btn-blue{background:#2980b9;color:#fff}
.btn-red{background:#c0392b;color:#fff}
.box{background:#f4f7fb;padding:14px;margin-top:14px;border-radius:12px}
.sub{background:#fff;padding:10px;border-radius:8px;margin-top:8px}
input,select,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc}
.row{display:flex;gap:16px;flex-wrap:wrap}
.row .box{flex:1}
@media(max-width:768px){.row{flex-direction:column}}
</style>
</head>

<body>
<div class="card">

<h2>Faculty Dashboard</h2>

<!-- HOME -->
<div id="home">
  <button class="btn" onclick="openAlloc()">Allocation</button>
  <button class="btn-blue" onclick="openEval()">Evaluation</button>
  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<!-- ================= ALLOCATION ================= -->
<div id="alloc" style="display:none">

  <div class="box">
    <b>Date</b>
    <input type="date" id="date" onchange="onDate()">
    <div id="dateStatus" style="margin-top:6px;color:#c0392b;font-weight:600;"></div>
  </div>

  <div class="box">
    <b>Group Discussion</b>
    <div id="gdExisting" class="sub"></div>
    <button id="gdOpenBtn" class="btn" disabled onclick="loadGD()">Allocate / Update GD</button>
    <div id="gdBox" class="sub" style="display:none"></div>
    <button id="saveGDBtn" class="btn" style="display:none" onclick="saveGD()">Save / Update GD</button>
  </div>

  <div class="box">
    <b>Seminar</b>
    <div id="semExisting" class="sub"></div>
    <button id="semOpenBtn" class="btn" disabled onclick="loadSeminar()">Allocate / Update Seminar</button>
    <div id="semBox" class="sub" style="display:none"></div>
    <button id="saveSemBtn" class="btn" style="display:none" onclick="saveSeminar()">Save / Update Seminar</button>
  </div>

  <div class="box">
    <b>Personal Interview</b>
    <div id="piExisting" class="sub"></div>
    <button id="piOpenBtn" class="btn" disabled onclick="loadPI()">Allocate / Update PI</button>
    <div id="piBox" class="sub" style="display:none"></div>
    <button id="savePIBtn" class="btn" style="display:none" onclick="savePI()">Save / Update PI</button>
  </div>

  <button class="btn-red" onclick="closeAlloc()">Close</button>
</div>

<!-- ================= EVALUATION ================= -->
<div id="evaluation" style="display:none">
  <h3>Evaluate Students</h3>
  <select id="studentSelect"></select>
  <button class="btn-red" onclick="closeEval()">Close</button>
</div>

</div>

<script>
/* ðŸ”´ PUT YOUR BACKEND URL HERE */
const BACKEND = "https://script.google.com/macros/s/AKfycbyMlgMl7L47Cxcgq1OBV_xIDbeC89-ct8Z_XQgSzW2mv1RQ6BkL1p-XdHPUFIgXOGLXqw/exec";

/* ---------- NAV ---------- */
function openAlloc(){
  home.style.display="none";
  evaluation.style.display="none";
  alloc.style.display="block";
  date.disabled=false;
  gdOpenBtn.disabled=true;
  semOpenBtn.disabled=true;
  piOpenBtn.disabled=true;
}
function closeAlloc(){
  alloc.style.display="none";
  home.style.display="block";
}
function openEval(){
  home.style.display="none";
  alloc.style.display="none";
  evaluation.style.display="block";
}
function closeEval(){
  evaluation.style.display="none";
  home.style.display="block";
}
function logout(){location.href="login.html";}

/* ---------- DATE (FIXED) ---------- */
async function onDate(){
  date.disabled = true;

  // Always reset UI
  gdOpenBtn.disabled = true;
  semOpenBtn.disabled = true;
  piOpenBtn.disabled = true;

  gdBox.style.display="none";
  semBox.style.display="none";
  piBox.style.display="none";
  saveGDBtn.style.display="none";
  saveSemBtn.style.display="none";
  savePIBtn.style.display="none";

  // Load existing allocations (display only)
  await loadExisting();

  // ðŸ”‘ CRITICAL: always start from GD
  gdOpenBtn.disabled = false;
}

/* ---------- LOAD EXISTING ---------- */
async function loadExisting(){
  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:date.value
    })
  }).then(r=>r.json());

  const gd=[], sem=[], pi=[];
  res.allocations.forEach(a=>{
    if(a.category==="GD") gd.push(a);
    if(a.category==="SEMINAR") sem.push(a);
    if(a.category==="PI") pi.push(a);
  });

  gdExisting.innerHTML = gd.length ? gd.map(x=>`${x.name} [${x.topic}]`).join("<br>") : "<i>No GD</i>";
  semExisting.innerHTML = sem.length ? sem.map(x=>x.name).join("<br>") : "<i>No Seminar</i>";
  piExisting.innerHTML = pi.length ? pi.map(x=>x.name).join("<br>") : "<i>No PI</i>";
}

/* ---------- GD / SEM / PI (UNCHANGED) ---------- */
async function loadGD(){gdBox.style.display="block";saveGDBtn.style.display="block";}
async function saveGD(){gdBox.style.display="none";saveGDBtn.style.display="none";semOpenBtn.disabled=false;}
async function loadSeminar(){semBox.style.display="block";saveSemBtn.style.display="block";}
async function saveSeminar(){semBox.style.display="none";saveSemBtn.style.display="none";piOpenBtn.disabled=false;}
async function loadPI(){piBox.style.display="block";savePIBtn.style.display="block";}
async function savePI(){piBox.style.display="none";savePIBtn.style.display="none";}
</script>

</body>
</html>
