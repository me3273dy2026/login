<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Segoe UI,Arial;
  background:#203a43;
  margin:0;
}
.card{
  max-width:1100px;
  margin:20px auto;
  background:#fff;
  padding:24px;
  border-radius:14px;
}
button{
  width:100%;
  padding:12px;
  margin-top:10px;
  border:none;
  border-radius:24px;
  font-weight:600;
  cursor:pointer;
}
button:disabled{background:#999;cursor:not-allowed;}
.btn{background:#203a43;color:#fff}
.btn-red{background:#c0392b;color:#fff}
.box{
  background:#f4f7fb;
  padding:16px;
  margin-top:14px;
  border-radius:12px;
}
.sub{
  background:#fff;
  padding:10px;
  border-radius:8px;
  margin-top:8px;
}
input{
  width:100%;
  padding:10px;
  border-radius:8px;
}
.status{
  text-align:center;
  font-weight:700;
  color:#c0392b;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div class="card">
<h2>Faculty Dashboard</h2>
<div id="status" class="status"></div>

<!-- HOME -->
<div id="home">
  <button class="btn" onclick="openAlloc()">Allocate Students</button>
  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<!-- ALLOCATION -->
<div id="alloc" style="display:none">

<div class="box">
  <b>Allocation Date</b>
  <input type="date" id="date" onchange="onDateChange()">
</div>

<!-- ================= GD ================= -->
<div class="box">
  <b>Group Discussion</b>
  <div id="gdExisting" class="sub"></div>

  <button id="gdOpenBtn" class="btn" disabled onclick="loadGD()">
    Allocate / Update GD
  </button>

  <div id="gdBox" class="sub" style="display:none"></div>

  <button id="saveGDBtn" class="btn" style="display:none" onclick="saveGD()">
    Save / Update GD
  </button>
</div>

<!-- ================= SEMINAR ================= -->
<div class="box">
  <b>Seminar</b>
  <div id="semExisting" class="sub"></div>

  <button id="semOpenBtn" class="btn" disabled onclick="loadSeminar()">
    Allocate / Update Seminar
  </button>

  <div id="semBox" class="sub" style="display:none"></div>

  <button id="saveSemBtn" class="btn" style="display:none" onclick="saveSeminar()">
    Save / Update Seminar
  </button>
</div>

<!-- ================= PI ================= -->
<div class="box">
  <b>Personal Interview</b>
  <div id="piExisting" class="sub"></div>

  <button id="piOpenBtn" class="btn" disabled onclick="loadPI()">
    Allocate / Update PI
  </button>

  <div id="piBox" class="sub" style="display:none"></div>

  <button id="savePIBtn" class="btn" style="display:none" onclick="savePI()">
    Save / Update PI
  </button>
</div>

<button class="btn-red" onclick="closeAlloc()">Close</button>
</div>
</div>

<script>
const BACKEND = "https://script.google.com/macros/s/AKfycbzQSaxz1qtI9lBNFlNGSoshLG1LD9fITOWNSrjif12ZRCQUndCyzg-JKe85DKKuOjyp0A/exec";

/* ---------- NAV ---------- */
function openAlloc(){
  home.style.display="none";
  alloc.style.display="block";
}
function closeAlloc(){
  alloc.style.display="none";
  home.style.display="block";
}
function logout(){ location.href="login.html"; }

/* ---------- DATE ---------- */
async function onDateChange(){
  status.innerText="Loading… Please wait";

  gdOpenBtn.disabled = true;
  semOpenBtn.disabled = true;
  piOpenBtn.disabled = true;

  hideAllSelectors();

  await loadExisting();
  gdOpenBtn.disabled = false;

  status.innerText="";
}

/* ---------- LOAD EXISTING ---------- */
async function loadExisting(){
  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:date.value
    })
  }).then(r=>r.json());

  const gd=[], sem=[], pi=[];
  res.allocations.forEach(a=>{
    if(a.category==="GD") gd.push(a);
    if(a.category==="SEMINAR") sem.push(a);
    if(a.category==="PI") pi.push(a);
  });

  gdExisting.innerHTML = gd.length
    ? gd.map(x=>`${x.name} <b>[${x.topic}]</b>`).join("<br>")
    : "<i>No GD</i>";

  semExisting.innerHTML = sem.length
    ? sem.map(x=>x.name).join("<br>")
    : "<i>No Seminar</i>";

  piExisting.innerHTML = pi.length
    ? pi.map(x=>x.name).join("<br>")
    : "<i>No PI</i>";

  if(gd.length) semOpenBtn.disabled = false;
  if(gd.length || sem.length) piOpenBtn.disabled = false;
}

/* ---------- GD ---------- */
async function loadGD(){
  status.innerText="Loading… Please wait";
  hideAllSelectors();

  gdOpenBtn.style.display="none";
  gdBox.style.display="block";
  saveGDBtn.style.display="block";
  gdBox.innerHTML="";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getGDTopicStatus",
      date:date.value
    })
  }).then(r=>r.json());

  res.topics.forEach(t=>{
    gdBox.innerHTML+=`
      <label>
        <input type="checkbox" value="${t.topic}" ${t.checked?"checked":""}>
        ${t.topic}
      </label><br>`;
  });

  status.innerText="";
}

async function saveGD(){
  const topics=[...gdBox.querySelectorAll("input:checked")].map(i=>i.value);
  if(!topics.length){ alert("Select at least one GD topic"); return; }

  status.innerText="Saving GD… Please wait";

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      date:date.value,
      topics:topics.join(",")
    })
  });

  gdOpenBtn.style.display="block";
  saveGDBtn.style.display="none";
  gdBox.style.display="none";

  await loadExisting();
  semOpenBtn.disabled = false;
  status.innerText="";
}

/* ---------- SEMINAR ---------- */
async function loadSeminar(){
  status.innerText="Loading… Please wait";
  hideAllSelectors();

  semOpenBtn.style.display="none";
  semBox.style.display="block";
  saveSemBtn.style.display="block";
  semBox.innerHTML="";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getSeminarStudentStatus",
      date:date.value
    })
  }).then(r=>r.json());

  res.students.forEach(s=>{
    semBox.innerHTML+=`
      <label>
        <input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}>
        ${s.name}
      </label><br>`;
  });

  status.innerText="";
}

async function saveSeminar(){
  const checked=[...semBox.querySelectorAll("input:checked")];
  if(!checked.length){ alert("Select at least one student"); return; }

  status.innerText="Saving Seminar… Please wait";

  const rolls=checked.map(c=>c.value);

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"SEMINAR",
      date:date.value,
      rolls:rolls.join(",")
    })
  });

  semOpenBtn.style.display="block";
  saveSemBtn.style.display="none";
  semBox.style.display="none";

  await loadExisting();
  piOpenBtn.disabled = false;
  status.innerText="";
}

/* ---------- PI ---------- */
async function loadPI(){
  status.innerText="Loading… Please wait";
  hideAllSelectors();

  piOpenBtn.style.display="none";
  piBox.style.display="block";
  savePIBtn.style.display="block";
  piBox.innerHTML="";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getPIStudentStatus",
      date:date.value
    })
  }).then(r=>r.json());

  res.students.forEach(s=>{
    piBox.innerHTML+=`
      <label>
        <input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}>
        ${s.name}
      </label><br>`;
  });

  status.innerText="";
}

async function savePI(){
  const checked=[...piBox.querySelectorAll("input:checked")];
  if(!checked.length){ alert("Select at least one student"); return; }

  status.innerText="Saving PI… Please wait";

  const rolls=checked.map(c=>c.value);

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"PI",
      date:date.value,
      rolls:rolls.join(",")
    })
  });

  piOpenBtn.style.display="block";
  savePIBtn.style.display="none";
  piBox.style.display="none";

  await loadExisting();
  status.innerText="";
}

/* ---------- UTIL ---------- */
function hideAllSelectors(){
  gdBox.style.display = semBox.style.display = piBox.style.display = "none";
  saveGDBtn.style.display = saveSemBtn.style.display = savePIBtn.style.display = "none";
}
</script>

</body>
</html>
