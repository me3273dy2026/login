<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  margin:0;
  display:flex;
  justify-content:center;
}
.card{
  background:#fff;
  width:100%;
  max-width:1200px;
  margin:24px 12px;
  padding:28px;
  border-radius:14px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{text-align:center;color:#e67e22;margin-bottom:6px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:22px;}
button{
  width:100%;
  padding:14px;
  margin-top:14px;
  border:none;
  border-radius:30px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}
button:disabled{
  background:#999;
  cursor:not-allowed;
  opacity:0.6;
}
.btn-main{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;}
.btn-red{background:#c0392b;color:#fff;}
.btn-close{background:#7f8c8d;color:#fff;}
.btn-eval{
  background:linear-gradient(135deg,#3498db,#1abc9c);
  color:#fff;
}
.section{display:none;margin-top:24px;}
label{font-weight:600;margin-top:12px;display:block;}
select,input,textarea{
  width:100%;
  padding:10px 12px;
  margin-top:6px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:15px;
}
textarea{min-height:90px;}
.row{display:flex;gap:16px;margin-top:18px;}
.box{
  flex:1;
  background:#f8f9fa;
  padding:16px;
  border-radius:12px;
}
.box h3{
  margin:18px 0 8px;
  color:#203a43;
  font-size:15px;
  font-weight:600;
  border-bottom:1px solid #e1e1e1;
  padding-bottom:6px;
}
.sub{background:#fff;padding:10px;border-radius:8px;margin-top:8px;}
.footer{
  margin-top:32px;
  text-align:center;
  font-size:13px;
  color:#5f6f78;
  font-weight:600;
}
.footer div{font-size:12px;color:#7a8a93;}
#loaderOverlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.85);
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.spinner{
  width:48px;
  height:48px;
  border:5px solid #ddd;
  border-top:5px solid #e67e22;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
.loader-text{margin-top:12px;font-weight:600;color:#203a43;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>

<body>
<div class="card">

<h1>Faculty Dashboard</h1>
<h2>ME3273 Â· GD Â· Seminar Â· PI</h2>

<div id="home">
  <button class="btn-eval" onclick="openEvaluate()">Evaluate Students</button>
  <button class="btn-main" onclick="openAllocate()">Allocate Students</button>
  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<div id="allocate" class="section">
  <h2>Student Allocation</h2>
  <label>Date</label>
  <input type="date" id="date" onchange="onDate()">

  <div class="box">
    <h3>Group Discussion</h3>
    <div id="gdExisting" class="sub"></div>
    <button id="gdOpenBtn" class="btn-main" disabled onclick="loadGD()">Allocate / Update GD</button>
    <div id="gdBox" class="sub" style="display:none"></div>
    <button id="saveGDBtn" class="btn-main" style="display:none" onclick="saveGD()">Save GD</button>
  </div>

  <div class="box">
    <h3>Seminar</h3>
    <div id="semExisting" class="sub"></div>
    <button id="semOpenBtn" class="btn-main" disabled onclick="loadSeminar()">Allocate / Update Seminar</button>
    <div id="semBox" class="sub" style="display:none"></div>
    <button id="saveSemBtn" class="btn-main" style="display:none" onclick="saveSeminar()">Save Seminar</button>
  </div>

  <div class="box">
    <h3>Personal Interview</h3>
    <div id="piExisting" class="sub"></div>
    <button id="piOpenBtn" class="btn-main" disabled onclick="loadPI()">Allocate / Update PI</button>
    <div id="piBox" class="sub" style="display:none"></div>
    <button id="savePIBtn" class="btn-main" style="display:none" onclick="savePI()">Save PI</button>
  </div>

  <button class="btn-close" onclick="closeSection()">Close</button>
</div>

<div id="evaluate" class="section">
  <h2>Evaluate Students</h2>

  <label>Select Student</label>
  <select id="studentSelect" onchange="onStudentChange()">
    <option value="">Loadingâ€¦</option>
  </select>

  <div class="row">
    <!-- LEFT COLUMN -->
    <div class="box">
      <h3>Student Details</h3>
      <div id="studentInfo" class="sub"></div>

      <h3>GD Topic</h3>
      <div id="gdTopicInfo" class="sub"></div>

      <h3>GD Group Members</h3>
      <div id="gdGroupInfo" class="sub"></div>

      <h3>Seminar Topic</h3>
      <div id="seminarInfo" class="sub"></div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="box">
      <h3>Evaluation</h3>

      <label>Type</label>
      <select id="typeSelect" onchange="onEvaluationTypeChange()">
        <option value="GD">GD</option>
        <option value="SEMINAR">Seminar</option>
        <option value="PI">PI</option>
      </select>

      <label>Marks</label>
      <input type="number" id="marks" min="0" max="100">

      <label>Positives</label>
      <textarea id="positives"></textarea>

      <label>Improvements</label>
      <textarea id="improvements"></textarea>

      <button id="saveEvalBtn" class="btn-main" onclick="saveEvaluation()">Save Evaluation</button>
    </div>
  </div>

  <button class="btn-close" onclick="closeSection()">Close</button>
</div>

<div id="loaderOverlay">
  <div class="spinner"></div>
  <div class="loader-text">Loadingâ€¦</div>
</div>

<div class="footer">
  Developed by Dr. Rajesh Akula
  <div>Â© 2026 Â· IIEST Shibpur</div>
</div>

</div>

<script>
  if(sessionStorage.getItem("facultyLoggedIn") !== "YES"){
  window.location.replace("faculty_login.html");
}
const BACKEND="https://script.google.com/macros/s/AKfycbyD77sKlqIbzx28FubvvsoQml67dqYC7jkFREj4CuwmFK-G1f45b3V6hx0X4cAj0rNX3w/exec";
const saveEvalBtn = document.getElementById("saveEvalBtn");
saveEvalBtn.disabled = true;   // disabled by default  
let allocationState={date:"",gdDone:false,semDone:false,piDone:false};
let sessionStage="GD";

const home     = document.getElementById("home");
const allocate = document.getElementById("allocate");
const evaluate = document.getElementById("evaluate");

const studentSelect = document.getElementById("studentSelect");
/* Navigation */
function openAllocate(){home.style.display="none";allocate.style.display="block";}
function openEvaluate(){home.style.display="none";evaluate.style.display="block";loadStudentsForEvaluation();}
function closeSection(){allocate.style.display="none";evaluate.style.display="none";home.style.display="block";}
function logout(){
  sessionStorage.removeItem("facultyLoggedIn");
  window.location.replace("faculty_login.html");
}

/* Loader */
function showLoader(t){loaderOverlay.style.display="flex";document.querySelector(".loader-text").innerText=t;}
function hideLoader(){loaderOverlay.style.display="none";}

/* Date */
function onDate(){
  allocationState={date:date.value,gdDone:false,semDone:false,piDone:false};
  sessionStage="GD";
  resetAllocationUI();
  showLoader("Loading allocationsâ€¦");
  loadAllocationsByDate(date.value);
}

function resetAllocationUI(){
  gdExisting.innerHTML = "";
  semExisting.innerHTML = "";
  piExisting.innerHTML = "";

  gdBox.style.display = "none";
  semBox.style.display = "none";
  piBox.style.display = "none";

  saveGDBtn.style.display = "none";
  saveSemBtn.style.display = "none";
  savePIBtn.style.display = "none";

  // ðŸ”‘ CRITICAL FIX: restore Allocate buttons visibility
  gdOpenBtn.style.display  = "block";
  semOpenBtn.style.display = "block";
  piOpenBtn.style.display  = "block";

  gdOpenBtn.disabled  = true;
  semOpenBtn.disabled = true;
  piOpenBtn.disabled  = true;
}

function updateButtons(){
  gdOpenBtn.disabled=semOpenBtn.disabled=piOpenBtn.disabled=true;
  if(sessionStage==="GD") gdOpenBtn.disabled=false;
  else if(sessionStage==="SEMINAR") semOpenBtn.disabled=false;
  else if(sessionStage==="PI") piOpenBtn.disabled=false;
}

function loadAllocationsByDate(d){
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getAllocationsByDate",date:d})})
  .then(r=>r.json())
  .then(res=>{
    const gd = res.allocations.filter(a=>a.category==="GD");

if(gd.length){
  const groups = {};
  gd.forEach(a=>{
    if(!groups[a.topic]) groups[a.topic] = [];
    groups[a.topic].push(a.roll+" - "+a.name);
  });

  gdExisting.innerHTML = Object.keys(groups)
    .map(t =>
      `<b>Topic: ${t}</b><br>${groups[t].join("<br>")}`
    )
    .join("<br><br>");
}else{
  gdExisting.innerHTML = "-";
}
   semExisting.innerHTML =
  res.allocations
    .filter(a=>a.category==="SEMINAR")
    .map(a =>
      `${a.roll} - ${a.name} (${a.seminarTopic})`
    )
    .join("<br>") || "-";
    piExisting.innerHTML=res.allocations.filter(a=>a.category==="PI").map(a=>a.roll+" - "+a.name).join("<br>")||"-";
    updateButtons();
  })
  .finally(hideLoader);
}

/* Allocation actions */
function loadGD(){
  showLoader("Loading GDâ€¦");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getGDTopicStatus",
      date: allocationState.date
    })
  })
  .then(r=>r.json())
  .then(res=>{
    // ðŸ”‘ Hide Allocate/Update GD button
    gdOpenBtn.style.display = "none";

    // ðŸ”‘ Show GD topics + Save button
    gdBox.style.display = "block";
    saveGDBtn.style.display = "block";
    saveGDBtn.disabled = false;

    gdBox.innerHTML = res.topics.map(t=>`
      <label>
        <input type="checkbox" value="${t.topic}" ${t.checked?"checked":""}>
        ${t.topic}
      </label>
    `).join("");
  })
  .finally(hideLoader);
}
  function saveGD(){
  showLoader("Saving GDâ€¦");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      date: allocationState.date,
      topics: [...gdBox.querySelectorAll("input:checked")]
                .map(i=>i.value).join(",")
    })
  })
  .then(()=>{
    // ðŸ”‘ Advance workflow
    sessionStage = "SEMINAR";

    // ðŸ”‘ HIDE GD UI completely
    gdBox.style.display = "none";
    saveGDBtn.style.display = "none";

    // (GD allocate button must remain hidden in this cycle)
    // gdOpenBtn stays hidden

    // Reload allocations & enable Seminar
    loadAllocationsByDate(allocationState.date);
  })
  .finally(hideLoader);
}
function loadSeminar(){
  showLoader("Loading Seminarâ€¦");

  // ðŸ”‘ Hide Allocate/Update Seminar button
  semOpenBtn.style.display = "none";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getSeminarStudentStatus",
      date: allocationState.date
    })
  })
  .then(r=>r.json())
  .then(res=>{
    semBox.style.display = "block";
    saveSemBtn.style.display = "block";
    saveSemBtn.disabled = false;

    semBox.innerHTML = res.students.map(s=>`
      <label>
        <input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}>
        ${s.roll} - ${s.name}
      </label>
    `).join("");
  })
  .finally(hideLoader);
}
function saveSeminar(){
  showLoader("Saving Seminarâ€¦");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"SEMINAR",
      date: allocationState.date,
      rolls: [...semBox.querySelectorAll("input:checked")]
              .map(i=>i.value).join(",")
    })
  })
  .then(()=>{
    // ðŸ”‘ Advance workflow
    sessionStage = "PI";

    // ðŸ”‘ Hide Seminar UI
    semBox.style.display = "none";
    saveSemBtn.style.display = "none";

    // Reload allocations & enable PI
    loadAllocationsByDate(allocationState.date);
  })
  .finally(hideLoader);
}
function loadPI(){
  showLoader("Loading PIâ€¦");

  // ðŸ”‘ Hide Allocate/Update PI button
  piOpenBtn.style.display = "none";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getPIStudentStatus",
      date: allocationState.date
    })
  })
  .then(r=>r.json())
  .then(res=>{
    piBox.style.display = "block";
    savePIBtn.style.display = "block";
    savePIBtn.disabled = false;

    piBox.innerHTML = res.students.map(s=>`
      <label>
        <input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}>
        ${s.roll} - ${s.name}
      </label>
    `).join("");
  })
  .finally(hideLoader);
}
  function savePI(){
  showLoader("Saving PIâ€¦");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"PI",
      date: allocationState.date,
      rolls: [...piBox.querySelectorAll("input:checked")]
              .map(i=>i.value).join(",")
    })
  })
  .then(()=>{
    // ðŸ”‘ Reset workflow (cycle complete)
    sessionStage = "GD";

    // ðŸ”‘ Hide PI UI
    piBox.style.display = "none";
    savePIBtn.style.display = "none";

    loadAllocationsByDate(allocationState.date);
  })
  .finally(hideLoader);
}
window.onload=resetAllocationUI;
  function loadStudentsForEvaluation(){
  showLoader("Loading studentsâ€¦");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllStudents"
    })
  })
  .then(r=>r.json())
  .then(res=>{
    studentSelect.innerHTML = `<option value="">Select Student</option>` +
      res.students.map(s =>
        `<option value="${s.roll}">
          ${s.roll} - ${s.name}
        </option>`
      ).join("");
  })
  .finally(hideLoader);
}
 function onStudentChange(){
  const roll = studentSelect.value;

  if(!roll){
    clearStudentUI();
    saveEvalBtn.disabled = true;
    return;
  }

  saveEvalBtn.disabled = false;
  showLoader("Loading student detailsâ€¦");

  Promise.all([
    // Student basic details
    fetch(BACKEND,{
      method:"POST",
      body:new URLSearchParams({
        action:"getStudentDetailsByRoll",
        roll
      })
    }).then(r=>r.json()),

    // GD group
    fetch(BACKEND,{
      method:"POST",
      body:new URLSearchParams({
        action:"getGDGroupByRoll",
        roll
      })
    }).then(r=>r.json()),

    // GD topic
    loadGDTopicForStudent(roll),

    // Latest evaluation
    loadLatestPerformance()
  ])
  .then(([student, gd])=>{
    // Student info
    studentInfo.innerHTML = `
      <b>${student.roll}</b><br>
      ${student.name}
    `;

    seminarInfo.innerHTML = student.seminarTopic || "-";

    if(gd.status==="OK"){
      gdGroupInfo.innerHTML = gd.group
        .map(m=>`${m.roll} - ${m.name}`)
        .join("<br>");
    }else{
      gdGroupInfo.innerHTML = "-";
    }
  })
  .finally(hideLoader);
}
  function loadGDTopicForStudent(roll){
  return fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getMyLatestPastAllocation",
      token: roll
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="FOUND" && res.category==="GD"){
      gdTopicInfo.innerHTML = res.topic || "-";
    }else{
      gdTopicInfo.innerHTML = "-";
    }
  });
}
  function loadLatestPerformance(){
  const roll = studentSelect.value;
  const type = typeSelect.value;

  if(!roll){
    return Promise.resolve();
  }

  return fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getLatestPerformance",
      roll,
      type
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="FOUND"){
      marks.value = res.marks;
      positives.value = res.positives;
      improvements.value = res.improvements;
    }else{
      marks.value = "";
      positives.value = "";
      improvements.value = "";
    }
  });
}
  function saveEvaluation(){
  const roll = studentSelect.value;
  const type = typeSelect.value;

  if(!roll){
    alert("Please select a student");
    return;
  }

  showLoader("Saving evaluationâ€¦");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"savePerformance",
      roll,
      type,
      marks: marks.value,
      positives: positives.value,
      improvements: improvements.value
    })
  })
  .then(r=>r.json())
  .then(()=>{
    // ðŸ”‘ CRITICAL FIX: reload latest saved evaluation
    return fetch(BACKEND,{
      method:"POST",
      body:new URLSearchParams({
        action:"getLatestPerformance",
        roll,
        type
      })
    });
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="FOUND"){
      marks.value = res.marks;
      positives.value = res.positives;
      improvements.value = res.improvements;
    }
    alert("Evaluation saved successfully");
  })
  .finally(hideLoader);
}
  function onEvaluationTypeChange(){
  const roll = studentSelect.value;
  if(!roll) return;

  showLoader("Loading evaluationâ€¦");

  loadLatestPerformance()
    .finally(hideLoader);
}
  function clearStudentUI(){
  studentInfo.innerHTML = "";
  gdTopicInfo.innerHTML = "";
  gdGroupInfo.innerHTML = "";
  seminarInfo.innerHTML = "";

  marks.value = "";
  positives.value = "";
  improvements.value = "";
  saveEvalBtn.disabled = true;
}
</script>
</body>
</html>

