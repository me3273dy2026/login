<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;margin:0;
  display:flex;justify-content:center;
}
.card{
  background:#fff;
  width:100%;max-width:1100px;
  margin:24px 12px;
  padding:28px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{text-align:center;color:#e67e22;margin-bottom:4px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:14px;}

.status{
  text-align:center;
  font-weight:700;
  color:#c0392b;
  margin-bottom:14px;
}

button{
  width:100%;padding:12px;margin-top:12px;
  border:none;border-radius:30px;
  font-size:15px;font-weight:600;
  cursor:pointer;
}
button:disabled{background:#999;cursor:not-allowed;}

.btn-main{background:#203a43;color:#fff;}
.btn-alloc{background:#27ae60;color:#fff;}
.btn-eval{background:#2980b9;color:#fff;}
.btn-close{background:#7f8c8d;color:#fff;}
.btn-logout{background:#c0392b;color:#fff;}

.section{display:none;margin-top:20px;}
.box{
  background:#f5f7fa;
  padding:16px;
  border-radius:12px;
  margin-top:14px;
}
.sublist{
  background:#fff;
  padding:12px;
  border-radius:10px;
  margin-top:10px;
}

input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
}
</style>
</head>

<body>

<div class="card">

<h1>Faculty Dashboard</h1>
<h2>ME3273 Â· Weekly Allocation & Evaluation</h2>

<div id="status" class="status"></div>

<!-- HOME -->
<div id="home">
  <button class="btn-alloc" onclick="openAllocate()">Allocate Students</button>
  <button class="btn-eval" onclick="openEvaluate()">Evaluate Students</button>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<!-- ================= ALLOCATION ================= -->
<div id="allocate" class="section">

<div class="box">
  <label><b>Allocation Date</b></label>
  <input type="date" id="allocDate" onchange="onDateChange()">
</div>

<!-- ================= GD ================= -->
<div class="box">
  <h3>Group Discussion</h3>

  <div id="gdExisting" class="sublist">
    <i>Select a date to view GD allocations</i>
  </div>

  <button id="gdOpenBtn"
          class="btn-main"
          disabled
          onclick="loadGDSelection()">
    Allocate / Update GD Topics
  </button>

  <div id="gdSelectBox" class="sublist" style="display:none"></div>

  <button id="saveGDBtn"
          class="btn-main"
          style="display:none"
          onclick="saveGD()">
    Save / Update GD
  </button>
</div>

<!-- ================= SEMINAR ================= -->
<div class="box">
  <h3>Seminar</h3>

  <div id="seminarExisting" class="sublist"></div>
  <div id="seminarList" class="sublist"></div>

  <button id="saveSemBtn"
          class="btn-main"
          disabled
          onclick="saveSeminar()">
    Save / Update Seminar
  </button>
</div>

<!-- ================= PI ================= -->
<div class="box">
  <h3>Personal Interview</h3>

  <div id="piExisting" class="sublist"></div>
  <div id="piList" class="sublist"></div>

  <button id="savePIBtn"
          class="btn-main"
          disabled
          onclick="savePI()">
    Save / Update PI
  </button>
</div>

<button class="btn-close" onclick="closeAll()">Close</button>
</div>

<!-- ================= EVALUATION ================= -->
<div id="evaluate" class="section">
  <iframe src="faculty_evaluation.html"
    style="width:100%;height:700px;border:none;border-radius:12px">
  </iframe>
  <button class="btn-close" onclick="closeAll()">Close</button>
</div>

</div>

<script>
const BACKEND = "https://script.google.com/macros/s/AKfycbwtR83WSVuSgQyhp0kxHV27SIClPA3_b-D_RoNJsdp0AvRxV7Mhenl4zOiYRw8X2MU7Cg/exec";

/* ---------- NAV ---------- */
function openAllocate(){
  home.style.display="none";
  allocate.style.display="block";
  resetState();
}
function openEvaluate(){
  home.style.display="none";
  evaluate.style.display="block";
}
function closeAll(){
  allocate.style.display="none";
  evaluate.style.display="none";
  home.style.display="block";
}

/* ---------- STATE RESET ---------- */
function resetState(){
  gdOpenBtn.disabled = true;
  saveSemBtn.disabled = true;
  savePIBtn.disabled = true;
}

/* ---------- DATE CHANGE ---------- */
async function onDateChange(){
  if(!allocDate.value) return;

  status.textContent = "Loadingâ€¦ Please wait";
  resetState();

  gdOpenBtn.style.display="block";
  gdSelectBox.style.display="none";
  saveGDBtn.style.display="none";

  await loadExistingAllocations();

  gdOpenBtn.disabled = false;   // enable GD step
  status.textContent = "";
}

/* ---------- LOAD EXISTING ---------- */
async function loadExistingAllocations(){
  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:allocDate.value
    })
  }).then(r=>r.json());

  let hasGD=false, hasSem=false;

  const gd=[], sem=[], pi=[];
  res.allocations.forEach(a=>{
    if(a.category==="GD"){gd.push(a);hasGD=true;}
    if(a.category==="SEMINAR"){sem.push(a);hasSem=true;}
    if(a.category==="PI"){pi.push(a);}
  });

  gdExisting.innerHTML = gd.length
    ? gd.map(x=>`${x.roll} â€“ ${x.name} <b>[${x.topic}]</b>`).join("<br>")
    : "<i>No GD scheduled</i>";

  seminarExisting.innerHTML = sem.length
    ? sem.map(x=>`${x.roll} â€“ ${x.name}`).join("<br>")
    : "<i>No Seminar</i>";

  piExisting.innerHTML = pi.length
    ? pi.map(x=>`${x.roll} â€“ ${x.name}`).join("<br>")
    : "<i>No PI</i>";

  if(hasGD){
    saveSemBtn.disabled = false;
    await loadSeminarSelection();   // ðŸ”¥ restore seminar list
  }
  if(hasGD && hasSem){
    savePIBtn.disabled = false;
  }
}

/* ---------- GD ---------- */
async function loadGDSelection(){
  status.textContent = "Loadingâ€¦ Please wait";

  gdOpenBtn.style.display="none";
  gdSelectBox.style.display="block";
  saveGDBtn.style.display="block";
  saveGDBtn.disabled = true;
  gdSelectBox.innerHTML="";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getGDTopicStatus",
      date:allocDate.value
    })
  }).then(r=>r.json());

  res.topics.forEach(t=>{
    gdSelectBox.innerHTML += `
      <label>
        <input type="checkbox" value="${t.topic}" ${t.checked?"checked":""}>
        ${t.topic}
      </label><br>`;
  });

  saveGDBtn.disabled = false;
  status.textContent = "";
}

async function saveGD(){
  status.textContent = "Updating Group Discussionâ€¦ Please wait";

  const topics=[...gdSelectBox.querySelectorAll("input:checked")]
    .map(i=>i.value);

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      date:allocDate.value,
      topics:topics.join(",")
    })
  });

  gdSelectBox.style.display="none";
  saveGDBtn.style.display="none";
  gdOpenBtn.style.display="block";

  await loadExistingAllocations();
  status.textContent = "";
}

/* ---------- SEMINAR (RESTORED) ---------- */
async function loadSeminarSelection(){
  seminarList.innerHTML="";

  const eligible = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligibleSeminar",
      date:allocDate.value
    })
  }).then(r=>r.json());

  const existing = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:allocDate.value
    })
  }).then(r=>r.json());

  const assignedToday = new Set(
    existing.allocations
      .filter(a=>a.category==="SEMINAR")
      .map(a=>a.roll)
  );

  if(eligible.students.length===0){
    seminarList.innerHTML="<i>No eligible students</i>";
    return;
  }

  eligible.students.forEach(s=>{
    seminarList.innerHTML += `
      <label>
        <input type="checkbox"
               value="${s.roll}"
               ${assignedToday.has(s.roll)?"checked":""}>
        ${s.roll} â€“ ${s.name}
      </label><br>`;
  });
}

async function saveSeminar(){
  status.textContent="Updating Seminarâ€¦ Please wait";
  saveSemBtn.disabled=true;

  const rolls=[...seminarList.querySelectorAll("input:checked")]
    .map(i=>i.value);

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"SEMINAR",
      date:allocDate.value,
      rolls:rolls.join(",")
    })
  });

  await loadExistingAllocations();
  savePIBtn.disabled=false;
  status.textContent="";
}

/* ---------- PI ---------- */
async function savePI(){
  status.textContent="Updating Personal Interviewâ€¦ Please wait";
  savePIBtn.disabled=true;

  const eligible = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligiblePI",
      date:allocDate.value
    })
  }).then(r=>r.json());

  piList.innerHTML="";
  eligible.students.forEach(s=>{
    piList.innerHTML+=`
      <label>
        <input type="checkbox" value="${s.roll}">
        ${s.roll} â€“ ${s.name}
      </label><br>`;
  });

  status.textContent="";
}

/* ---------- LOGOUT ---------- */
function logout(){
  location.href="login.html";
}
</script>

</body>
</html>
