<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Segoe UI;background:#203a43;margin:0;padding:20px}
.card{background:#fff;max-width:1100px;margin:auto;padding:25px;border-radius:12px}
h2{margin-top:30px}
label{display:block;margin-top:12px;font-weight:600}
select,input,textarea,button{width:100%;padding:8px;margin-top:6px}
button{background:#e67e22;color:#fff;border:none;border-radius:20px;margin-top:12px}
.row{display:flex;gap:15px}
.box{flex:1;background:#f4f6f7;padding:15px;border-radius:10px}
@media(max-width:800px){.row{flex-direction:column}}
</style>
</head>

<body>
<div class="card">

<h1>Faculty Dashboard</h1>

<!-- PERFORMANCE -->
<h2>Performance Evaluation</h2>
<label>Student</label>
<select id="studentSelect"></select>

<label>Type</label>
<select id="typeSelect">
  <option>GD</option><option>SEMINAR</option><option>PI</option>
</select>

<label>Marks</label>
<input id="marks" type="number">

<label>Positives</label>
<textarea id="positives"></textarea>

<label>Improvements</label>
<textarea id="improvements"></textarea>

<button onclick="savePerf()">Save Performance</button>

<!-- GD -->
<h2>GD Allocation</h2>
<label>Date</label>
<input type="date" id="gdDate">
<label>GD Group</label>
<select id="gdTopic"></select>
<button onclick="allocateGD()">Allocate GD</button>

<!-- SEMINAR -->
<h2>Seminar Allocation</h2>
<label>Eligible Students</label>
<select id="seminarSelect" multiple size="6"></select>
<button onclick="allocateSeminar()">Allocate Seminar</button>

<!-- PI -->
<h2>PI Allocation</h2>
<label>Eligible Students</label>
<select id="piSelect" multiple size="6"></select>
<button onclick="allocatePI()">Allocate PI</button>

</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbxDGaCg-9Spib6xlj7ldfc2fc9Fwa11y4e_kK8lRlthHqy2H3UfglHUvDr2eSufsZ6p9A/exec";

/* students */
fetch(BACKEND+"?action=getAllStudents")
.then(r=>r.json()).then(d=>{
  studentSelect.innerHTML='<option></option>';
  d.students.forEach(s=>{
    studentSelect.innerHTML+=`<option value="${s.roll}">${s.roll} - ${s.name}</option>`;
  });
});

/* GD topics */
fetch(BACKEND+"?action=getAvailableGDTopics")
.then(r=>r.json()).then(d=>{
  gdTopic.innerHTML='<option></option>';
  d.topics.forEach(t=>gdTopic.innerHTML+=`<option>${t}</option>`);
});

function savePerf(){
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"savePerformance",
    roll:studentSelect.value,
    type:typeSelect.value,
    marks:marks.value,
    positives:positives.value,
    improvements:improvements.value
  })}).then(()=>alert("Saved"));
}

function allocateGD(){
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"saveGDAllocation",
    topic:gdTopic.value,
    date:gdDate.value
  })}).then(()=>alert("GD Allocated"));
}

gdTopic.onchange = gdDate.onchange = loadSeminar;

function loadSeminar(){
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"getSeminarCandidates",
    date:gdDate.value,
    gdTopic:gdTopic.value
  })})
  .then(r=>r.json()).then(d=>{
    seminarSelect.innerHTML="";
    d.students.forEach(s=>seminarSelect.innerHTML+=
      `<option value="${s.roll}">${s.name}</option>`);
    piSelect.innerHTML="";
  });
}

seminarSelect.onchange=()=>{
  const sr=[...seminarSelect.selectedOptions].map(o=>o.value).join(",");
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"getPICandidates",
    date:gdDate.value,
    gdTopic:gdTopic.value,
    seminarRolls:sr
  })})
  .then(r=>r.json()).then(d=>{
    piSelect.innerHTML="";
    d.students.forEach(s=>piSelect.innerHTML+=
      `<option value="${s.roll}">${s.name}</option>`);
  });
};

function allocateSeminar(){
  const r=[...seminarSelect.selectedOptions].map(o=>o.value).join(",");
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"saveSeminarPIAllocation",
    date:gdDate.value,
    seminarRolls:r,
    piRolls:""
  })}).then(()=>alert("Seminar Allocated"));
}

function allocatePI(){
  const r=[...piSelect.selectedOptions].map(o=>o.value).join(",");
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"saveSeminarPIAllocation",
    date:gdDate.value,
    seminarRolls:"",
    piRolls:r
  })}).then(()=>alert("PI Allocated"));
}
</script>
</body>
</html>
