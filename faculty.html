<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  margin:0;
  display:flex;
  justify-content:center;
}
.card{
  background:#fff;
  width:100%;
  max-width:1200px;
  margin:24px 12px;
  padding:28px;
  border-radius:14px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{text-align:center;color:#e67e22;margin-bottom:6px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:22px;}
button{
  width:100%;
  padding:14px;
  margin-top:14px;
  border:none;
  border-radius:30px;
  font-size:16px;
  font-weight:600;
  cursor:pointer;
}
button:disabled{
  background:#999;
  cursor:not-allowed;
  opacity:0.6;
}
.btn-main{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;}
.btn-red{background:#c0392b;color:#fff;}
.btn-close{background:#7f8c8d;color:#fff;}
.btn-eval{
  background:linear-gradient(135deg,#3498db,#1abc9c);
  color:#fff;
}
.section{display:none;margin-top:24px;}
label{font-weight:600;margin-top:12px;display:block;}
select,input,textarea{
  width:100%;
  padding:10px 12px;
  margin-top:6px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:15px;
}
textarea{min-height:90px;}
.row{display:flex;gap:16px;margin-top:18px;}
.box{
  flex:1;
  background:#f8f9fa;
  padding:16px;
  border-radius:12px;
}
.box h3{
  margin:18px 0 8px;
  color:#203a43;
  font-size:15px;
  font-weight:600;
  border-bottom:1px solid #e1e1e1;
  padding-bottom:6px;
}
.sub{background:#fff;padding:10px;border-radius:8px;margin-top:8px;}
.footer{
  margin-top:32px;
  text-align:center;
  font-size:13px;
  color:#5f6f78;
  font-weight:600;
}
.footer div{font-size:12px;color:#7a8a93;}
#loaderOverlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,0.85);
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.spinner{
  width:48px;
  height:48px;
  border:5px solid #ddd;
  border-top:5px solid #e67e22;
  border-radius:50%;
  animation:spin 1s linear infinite;
}
.loader-text{margin-top:12px;font-weight:600;color:#203a43;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>

<body>
<div class="card">

<h1>Faculty Dashboard</h1>
<h2>ME3273 · GD · Seminar · PI</h2>

<div id="home">
  <button class="btn-eval" onclick="openEvaluate()">Evaluate Students</button>
  <button class="btn-main" onclick="openAllocate()">Allocate Students</button>
  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<div id="allocate" class="section">
  <h2>Student Allocation</h2>
  <label>Date</label>
  <input type="date" id="date" onchange="onDate()">

  <div class="box">
    <h3>Group Discussion</h3>
    <div id="gdExisting" class="sub"></div>
    <button id="gdOpenBtn" class="btn-main" disabled onclick="loadGD()">Allocate / Update GD</button>
    <div id="gdBox" class="sub" style="display:none"></div>
    <button id="saveGDBtn" class="btn-main" style="display:none" onclick="saveGD()">Save GD</button>
  </div>

  <div class="box">
    <h3>Seminar</h3>
    <div id="semExisting" class="sub"></div>
    <button id="semOpenBtn" class="btn-main" disabled onclick="loadSeminar()">Allocate / Update Seminar</button>
    <div id="semBox" class="sub" style="display:none"></div>
    <button id="saveSemBtn" class="btn-main" style="display:none" onclick="saveSeminar()">Save Seminar</button>
  </div>

  <div class="box">
    <h3>Personal Interview</h3>
    <div id="piExisting" class="sub"></div>
    <button id="piOpenBtn" class="btn-main" disabled onclick="loadPI()">Allocate / Update PI</button>
    <div id="piBox" class="sub" style="display:none"></div>
    <button id="savePIBtn" class="btn-main" style="display:none" onclick="savePI()">Save PI</button>
  </div>

  <button class="btn-close" onclick="closeSection()">Close</button>
</div>

<div id="evaluate" class="section">
  <h2>Evaluate Students</h2>

  <label>Select Student</label>
  <select id="studentSelect" onchange="onStudentChange()">
    <option value="">Loading…</option>
  </select>

  <div class="row">
    <!-- LEFT COLUMN -->
    <div class="box">
      <h3>Student Details</h3>
      <div id="studentInfo" class="sub"></div>

      <h3>GD Topic</h3>
      <div id="gdTopicInfo" class="sub"></div>

      <h3>GD Group Members</h3>
      <div id="gdGroupInfo" class="sub"></div>

      <h3>Seminar Topic</h3>
      <div id="seminarInfo" class="sub"></div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="box">
      <h3>Evaluation</h3>

      <label>Type</label>
      <select id="typeSelect" onchange="onEvaluationTypeChange()">
        <option value="GD">GD</option>
        <option value="SEMINAR">Seminar</option>
        <option value="PI">PI</option>
      </select>

      <label>Marks</label>
      <input type="number" id="marks" min="0" max="100">

      <label>Positives</label>
      <textarea id="positives"></textarea>

      <label>Improvements</label>
      <textarea id="improvements"></textarea>

      <button id="saveEvalBtn" class="btn-main" onclick="saveEvaluation()">Save Evaluation</button>
    </div>
  </div>

  <button class="btn-close" onclick="closeSection()">Close</button>
</div>

<div id="loaderOverlay">
  <div class="spinner"></div>
  <div class="loader-text">Loading…</div>
</div>

<div class="footer">
  Developed by Dr. Rajesh Akula
  <div>© 2026 · IIEST Shibpur</div>
</div>

</div>

<script>
/* ================= AUTH ================= */
const facultyToken = sessionStorage.getItem("facultyToken");
if(!facultyToken){
  sessionStorage.clear();
  window.location.replace("faculty_login.html");
}

const BACKEND = "https://script.google.com/macros/s/AKfycbxxGH7NJJ8h2NbBuYaREszV-uVmN4jsbAS2VzDjd5tQLQNazL48NqcK9k0gywinWfG5nw/exec";

/* ================= DOM ================= */
const home = document.getElementById("home");
const allocate = document.getElementById("allocate");
const evaluate = document.getElementById("evaluate");

const dateInput = document.getElementById("date");

const gdExisting = document.getElementById("gdExisting");
const semExisting = document.getElementById("semExisting");
const piExisting = document.getElementById("piExisting");

const gdOpenBtn = document.getElementById("gdOpenBtn");
const semOpenBtn = document.getElementById("semOpenBtn");
const piOpenBtn = document.getElementById("piOpenBtn");

const gdBox = document.getElementById("gdBox");
const semBox = document.getElementById("semBox");
const piBox = document.getElementById("piBox");

const saveGDBtn = document.getElementById("saveGDBtn");
const saveSemBtn = document.getElementById("saveSemBtn");
const savePIBtn = document.getElementById("savePIBtn");

const loaderOverlay = document.getElementById("loaderOverlay");

const studentSelect = document.getElementById("studentSelect");
const studentInfo = document.getElementById("studentInfo");
const gdTopicInfo = document.getElementById("gdTopicInfo");
const gdGroupInfo = document.getElementById("gdGroupInfo");
const seminarInfo = document.getElementById("seminarInfo");

const typeSelect = document.getElementById("typeSelect");
const marks = document.getElementById("marks");
const positives = document.getElementById("positives");
const improvements = document.getElementById("improvements");
const saveEvalBtn = document.getElementById("saveEvalBtn");

saveEvalBtn.disabled = true;

/* ================= STATE ================= */
let allocationState = { date:"" };
let sessionStage = "GD";

/* ================= NAV ================= */
function openAllocate(){ home.style.display="none"; allocate.style.display="block"; }
function openEvaluate(){ home.style.display="none"; evaluate.style.display="block"; loadStudentsForEvaluation(); }
function closeSection(){ allocate.style.display="none"; evaluate.style.display="none"; home.style.display="block"; }

function logout(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"logout",
      token: facultyToken
    })
  }).finally(()=>{
    sessionStorage.clear();
    window.location.replace("faculty_login.html");
  });
}

/* ================= LOADER ================= */
function showLoader(t){
  loaderOverlay.style.display="flex";
  loaderOverlay.querySelector(".loader-text").innerText=t;
}
function hideLoader(){ loaderOverlay.style.display="none"; }

/* ================= DATE ================= */
function onDate(){
  allocationState.date = dateInput.value;
  sessionStage = "GD";
  resetAllocationUI();
  showLoader("Loading allocations…");
  loadAllocationsByDate(allocationState.date);
}

function resetAllocationUI(){
  gdExisting.innerHTML = semExisting.innerHTML = piExisting.innerHTML = "-";

  gdBox.style.display = semBox.style.display = piBox.style.display = "none";
  saveGDBtn.style.display = saveSemBtn.style.display = savePIBtn.style.display = "none";

  gdOpenBtn.style.display = semOpenBtn.style.display = piOpenBtn.style.display = "block";
  gdOpenBtn.disabled = semOpenBtn.disabled = piOpenBtn.disabled = true;
}

function updateButtons(){
  gdOpenBtn.disabled = semOpenBtn.disabled = piOpenBtn.disabled = true;
  if(sessionStage==="GD") gdOpenBtn.disabled=false;
  else if(sessionStage==="SEMINAR") semOpenBtn.disabled=false;
  else if(sessionStage==="PI") piOpenBtn.disabled=false;
}

/* ================= LOAD ALLOC ================= */
function loadAllocationsByDate(d){
  showLoader("Loading allocations…");

  Promise.all([
    // 1️⃣ GD topic → members
    fetch(BACKEND,{
      method:"POST",
      body:new URLSearchParams({
        action:"getGDDetailsByDate",
        token: facultyToken,
        date:d
      })
    }).then(r=>r.json()),

    // 2️⃣ Seminar + PI allocations
    fetch(BACKEND,{
      method:"POST",
      body:new URLSearchParams({
        action:"getAllocationsByDate",
        token: facultyToken,
        date:d
      })
    }).then(r=>r.json())
  ])
  .then(([gdRes, allocRes])=>{

    /* ---------- GD ---------- */
    if(gdRes.status === "OK" && Object.keys(gdRes.topics).length){
      gdExisting.innerHTML = Object.entries(gdRes.topics).map(
        ([topic, members]) =>
          `<b>${topic}</b><br>
           Members:<br>
           ${members.map(m=>`${m.name} - ${m.roll}`).join("<br>")}`
      ).join("<br><br>");
    }else{
      gdExisting.innerHTML = "-";
    }

    /* ---------- SEMINAR ---------- */
    semExisting.innerHTML = allocRes.allocations
      .filter(a=>a.category==="SEMINAR")
      .map(a=>`${a.roll} - ${a.name} (${a.seminarTopic})`)
      .join("<br>") || "-";

    /* ---------- PI ---------- */
    piExisting.innerHTML = allocRes.allocations
      .filter(a=>a.category==="PI")
      .map(a=>`${a.roll} - ${a.name}`)
      .join("<br>") || "-";

    updateButtons();
  })
  .finally(hideLoader);
}

/* ================= GD ================= */
function loadGD(){
  showLoader("Loading GD…");
  gdOpenBtn.style.display="none";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({ action:"getGDTopicStatus", token: facultyToken, date:allocationState.date })
  })
  .then(r=>r.json())
  .then(res=>{
    gdBox.style.display="block";
    saveGDBtn.style.display="block";
    gdBox.innerHTML = res.topics.map(t=>`
      <label><input type="checkbox" value="${t.topic}" ${t.checked?"checked":""}> ${t.topic}</label>
    `).join("");
  })
  .finally(hideLoader);
}

function saveGD(){
  saveGDBtn.disabled=true;
  showLoader("Saving GD…");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      token: facultyToken,
      date:allocationState.date,
      topics:[...gdBox.querySelectorAll("input:checked")].map(i=>i.value).join(",")
    })
  })
  .then(()=>{
    sessionStage="SEMINAR";
    gdBox.style.display=saveGDBtn.style.display="none";
    loadAllocationsByDate(allocationState.date);
  })
  .finally(()=>{ saveGDBtn.disabled=false; hideLoader(); });
}
function loadSeminar(){
  showLoader("Loading Seminar…");
  semOpenBtn.style.display = "none";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getSeminarStudentStatus",
      token: facultyToken,
      date: allocationState.date
    })
  })
  .then(r=>r.json())
  .then(res=>{
    semBox.style.display = "block";
    saveSemBtn.style.display = "block";

    semBox.innerHTML = res.students.map(s=>`
      <label>
        <input type="checkbox"
               value="${s.roll}"
               ${s.checked ? "checked" : ""}>
        ${s.roll} - ${s.name}
      </label>
    `).join("");
  })
  .finally(hideLoader);
}

function saveSeminar(){
  saveSemBtn.disabled = true;
  showLoader("Saving Seminar…");

  const selected = [...semBox.querySelectorAll("input:checked")]
                    .map(i=>i.value)
                    .join(",");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      token: facultyToken,
      date: allocationState.date,
      category: "SEMINAR",
      rolls: selected
    })
  })
  .then(()=>{
    sessionStage = "PI";
    semBox.style.display = saveSemBtn.style.display = "none";
    loadAllocationsByDate(allocationState.date);
  })
  .finally(()=>{
    saveSemBtn.disabled = false;
    hideLoader();
  });
}

/* ================= PI ================= */
function loadPI(){
  showLoader("Loading PI…");
  piOpenBtn.style.display = "none";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getPIStudentStatus",
      token: facultyToken,
      date: allocationState.date
    })
  })
  .then(r=>r.json())
  .then(res=>{
    piBox.style.display = "block";
    savePIBtn.style.display = "block";

    piBox.innerHTML = res.students.map(s=>`
      <label>
        <input type="checkbox"
               value="${s.roll}"
               ${s.checked ? "checked" : ""}>
        ${s.roll} - ${s.name}
      </label>
    `).join("");
  })
  .finally(hideLoader);
}

function savePI(){
  savePIBtn.disabled = true;
  showLoader("Saving PI…");

  const selected = [...piBox.querySelectorAll("input:checked")]
                    .map(i=>i.value)
                    .join(",");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      token: facultyToken,
      date: allocationState.date,
      category: "PI",
      rolls: selected
    })
  })
  .then(()=>{
    sessionStage = "DONE";
    piBox.style.display = savePIBtn.style.display = "none";
    loadAllocationsByDate(allocationState.date);
  })
  .finally(()=>{
    savePIBtn.disabled = false;
    hideLoader();
  });
}
/* ================= EVALUATION ================= */
function loadStudentsForEvaluation(){
  showLoader("Loading students…");
  fetch(BACKEND,{ method:"POST", body:new URLSearchParams({ action:"getAllStudents", token: facultyToken })})
  .then(r=>r.json())
  .then(res=>{
    studentSelect.innerHTML =
      `<option value="">Select Student</option>` +
      res.students.map(s=>`<option value="${s.roll}">${s.roll} - ${s.name}</option>`).join("");
  })
  .finally(hideLoader);
}

function onStudentChange(){
  const roll = studentSelect.value;
  if(!roll){ clearStudentUI(); return; }

  saveEvalBtn.disabled=false;
  showLoader("Loading student…");

  Promise.all([
    fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getStudentDetailsByRoll",token: facultyToken, roll})}).then(r=>r.json()),
    fetch(BACKEND,{method:"POST",body:new URLSearchParams({action:"getGDGroupByRoll",token: facultyToken, roll})}).then(r=>r.json()),
    loadLatestPerformance()
  ])
  .then(([stu,gd])=>{
    studentInfo.innerHTML = `<b>${stu.roll}</b><br>${stu.name}`;
    seminarInfo.innerText = stu.seminarTopic || "-";
    gdTopicInfo.innerText = "-";   // backend does not expose latest GD topic by roll
    gdGroupInfo.innerHTML = gd.status==="OK"
      ? gd.group.map(m=>`${m.roll} - ${m.name}`).join("<br>")
      : "-";
  })
  .finally(hideLoader);
}

function loadLatestPerformance(){
  const roll = studentSelect.value;
  if(!roll) return Promise.resolve();

  return fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getLatestPerformance",
      token: facultyToken,
      roll,
      type:typeSelect.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.status==="FOUND"){
      marks.value=res.marks;
      positives.value=res.positives;
      improvements.value=res.improvements;
    }else{
      marks.value=positives.value=improvements.value="";
    }
  });
}

function saveEvaluation(){
  saveEvalBtn.disabled=true;
  showLoader("Saving evaluation…");

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"savePerformance",
      token: facultyToken,
      roll:studentSelect.value,
      type:typeSelect.value,
      marks:marks.value,
      positives:positives.value,
      improvements:improvements.value
    })
  })
  .then(()=>alert("Evaluation saved"))
  .finally(()=>{ saveEvalBtn.disabled=false; hideLoader(); });
}

function clearStudentUI(){
  studentInfo.innerHTML=gdTopicInfo.innerHTML=gdGroupInfo.innerHTML=seminarInfo.innerHTML="";
  marks.value=positives.value=improvements.value="";
  saveEvalBtn.disabled=true;
}
  function onEvaluationTypeChange(){
  const roll = studentSelect.value;

  // Clear current inputs
  marks.value = "";
  positives.value = "";
  improvements.value = "";

  // If a student is selected, load latest evaluation for this type
  if(roll){
    showLoader("Loading previous evaluation…");
    loadLatestPerformance().finally(hideLoader);
  }
}
</script>
</body>
</html>

