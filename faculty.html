<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Segoe UI,Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;min-height:100vh;
  display:flex;justify-content:center;
}
.card{
  background:#fff;
  max-width:1100px;width:100%;
  margin:24px;padding:28px;
  border-radius:18px;
}
.box{
  background:#f4f7fb;
  padding:18px;margin-top:16px;
  border-radius:14px;
}
input,select{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  width:100%;
  margin-top:12px;
  padding:12px;
  border:none;border-radius:24px;
  background:#203a43;color:#fff;
  font-weight:600;
}
.sublist{
  background:#fff;padding:12px;
  border-radius:10px;margin-top:10px;
}
</style>
</head>

<body>
<div class="card">

<h2>Faculty Dashboard – Allocation</h2>

<div class="box">
  <label>Select Allocation Date</label>
  <input type="date" id="allocDate" onchange="onDateChange()">
</div>

<div class="box">
  <h3>Group Discussion</h3>
  <select id="gdTopic"></select>
  <button onclick="allocateGD()">Allocate GD</button>
  <div id="gdExisting" class="sublist"></div>
</div>

<div class="box">
  <h3>Seminar</h3>
  <div id="seminarExisting" class="sublist"></div>
  <div id="seminarList"></div>
  <button onclick="saveSeminar()">Save Seminar</button>
</div>

<div class="box">
  <h3>Personal Interview</h3>
  <div id="piExisting" class="sublist"></div>
  <div id="piList"></div>
  <button onclick="savePI()">Save PI</button>
</div>

</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbwHB2m5Xp3b6VEf6kpPTCctOCL_2_ynMHY9yGlASw0e5XUuF0VUs5anhmDGvSoFcFtqaw/exec";

function onDateChange(){
  loadGDTopics();
  loadAllocations();
}

function loadGDTopics(){
  gdTopic.innerHTML="<option value=''>Select / Update GD Topic</option>";
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAvailableGDTopics",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    res.topics.forEach(t=>{
      const o=document.createElement("option");
      o.value=t;o.textContent=t;
      gdTopic.appendChild(o);
    });
  });
}

function allocateGD(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      date:allocDate.value,
      topic:gdTopic.value
    })
  }).then(()=>{loadAllocations();loadSeminarEligible();});
}

function loadAllocations(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    const g={GD:[],SEMINAR:[],PI:[]};
    res.allocations.forEach(a=>g[a.category].push(a));

    gdExisting.innerHTML=g.GD.map(x=>`${x.roll} – ${x.name} [${x.topic}]`).join("<br>")||"No GD";
    seminarExisting.innerHTML=g.SEMINAR.map(x=>`${x.roll} – ${x.name}`).join("<br>")||"No Seminar";
    piExisting.innerHTML=g.PI.map(x=>`${x.roll} – ${x.name}`).join("<br>")||"No PI";
  });
}

function loadSeminarEligible(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligibleSeminar",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    seminarList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}"> ${s.roll} – ${s.name}</label><br>`
    ).join("");
  });
}

function saveSeminar(){
  save("SEMINAR","seminarList",loadPIEligible);
}

function loadPIEligible(){
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligiblePI",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    piList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}"> ${s.roll} – ${s.name}</label><br>`
    ).join("");
  });
}

function savePI(){
  save("PI","piList",loadAllocations);
}

function save(cat,id,cb){
  const rolls=[...document.querySelectorAll(`#${id} input:checked`)].map(i=>i.value);
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:cat,
      date:allocDate.value,
      rolls:rolls.join(",")
    })
  }).then(cb);
}
</script>
</body>
</html>
