<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Faculty Dashboard | ME3273</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
      min-height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
    }

    .card {
      background: #fff;
      width: 100%;
      max-width: 1200px;
      margin: 24px 12px;
      padding: 28px;
      border-radius: 14px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.25);
    }

    h1 {
      text-align: center;
      color: #e67e22;
      margin-bottom: 6px;
    }

    h2 {
      text-align: center;
      color: #555;
      font-size: 15px;
      margin-bottom: 22px;
    }

    button {
      width: 100%;
      padding: 14px;
      margin-top: 14px;
      border: none;
      border-radius: 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    button:disabled {
      background: #999;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .btn-main {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      color: #fff;
    }

    .btn-red {
      background: #c0392b;
      color: #fff;
    }

    .btn-close {
      background: #7f8c8d;
      color: #fff;
    }

    .section {
      display: none;
      margin-top: 24px;
    }

    label {
      font-weight: 600;
      margin-top: 12px;
      display: block;
    }

    select,
    input,
    textarea {
      width: 100%;
      padding: 10px 12px;
      margin-top: 6px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    textarea { min-height: 90px; }

    .row {
      display: flex;
      gap: 16px;
      margin-top: 18px;
    }

    .box {
      flex: 1;
      background: #f8f9fa;
      padding: 16px;
      border-radius: 12px;
    }

    .box h3 {
      margin: 18px 0 8px;
      color: #203a43;
      font-size: 15px;
      font-weight: 600;
      border-bottom: 1px solid #e1e1e1;
      padding-bottom: 6px;
    }

    .info-block { margin-bottom: 16px; }

    .info-content {
      padding: 8px 4px 2px;
      line-height: 1.55;
      color: #333;
    }

    .sub {
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      margin-top: 8px;
    }

    .loading {
      text-align: center;
      font-weight: 600;
      margin-top: 14px;
    }

    .footer {
      margin-top: 32px;
      text-align: center;
      font-size: 13px;
      color: #5f6f78;
      font-weight: 600;
    }

    .footer div {
      font-size: 12px;
      color: #7a8a93;
    }

    @media (max-width: 900px) {
      .row { flex-direction: column; }
    }

    #loaderOverlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid #ddd;
      border-top: 5px solid #e67e22;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loader-text {
      margin-top: 12px;
      font-weight: 600;
      color: #203a43;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>Faculty Dashboard</h1>
    <h2>ME3273 · GD · Seminar · PI</h2>

    <div id="home">
      <button class="btn-main" onclick="openAllocate()">Allocate Students</button>
      <button class="btn-main" onclick="openEvaluate()">Evaluate Students</button>
      <button class="btn-red" onclick="logout()">Logout</button>
    </div>

    <!-- ================= ALLOCATION ================= -->
    <!-- (HTML BODY CONTINUES — UNCHANGED, FORMATTED ONLY) -->

    <!-- ===== GLOBAL LOADER ===== -->
    <div id="loaderOverlay" style="display:none;">
      <div class="spinner"></div>
      <div class="loader-text">Loading… Please wait</div>
    </div>

    <div class="footer">
      Developed by Dr. Rajesh Akula
      <div>© 2026 · IIEST Shibpur</div>
    </div>
  </div>

  <script>
    /* ================= NAVIGATION ================= */
    function openAllocate() {
      home.style.display = "none";
      evaluate.style.display = "none";
      allocate.style.display = "block";

      allocStage = 0;
      date.disabled = false;
      date.value = "";
      dateStatus.innerText = "";

      gdOpenBtn.disabled = true;
      semOpenBtn.disabled = true;
      piOpenBtn.disabled = true;

      saveGDBtn.style.display = "none";
      saveSemBtn.style.display = "none";
      savePIBtn.style.display = "none";

      gdBox.style.display = "none";
      semBox.style.display = "none";
      piBox.style.display = "none";
    }

    function openEvaluate() {
      home.style.display = "none";
      allocate.style.display = "none";
      evaluate.style.display = "block";
      loadStudents();
    }

    function closeSection() {
      allocate.style.display = "none";
      evaluate.style.display = "none";
      home.style.display = "block";
    }

    function logout() {
      showLoader("Logging out…");
      setTimeout(() => {
        location.href = "login.html";
      }, 600);
    }

    /* ================= STATE ================= */
    let allocStage = 0;

    function updateAllocationButtons() {
      gdOpenBtn.disabled = true;
      semOpenBtn.disabled = true;
      piOpenBtn.disabled = true;

      if (allocStage === 1 && date.value) {
        gdOpenBtn.disabled = false;
      } else if (allocStage === 2) {
        semOpenBtn.disabled = false;
      } else if (allocStage === 3) {
        piOpenBtn.disabled = false;
      }
    }

    /* ================= CONFIG ================= */
    const BACKEND =
      "https://script.google.com/macros/s/AKfycby-g1UAWrOq9Opn2RP5RHTeUM2TzvVb-OUnBcQqll6kKuAJ4NJiIQGEDpyzjKFrVtJMgw/exec";

    /* ================= UI HELPERS ================= */
    function disableAllButtons() {
      document.querySelectorAll("button").forEach(b => {
        if (!b.classList.contains("btn-red") && !b.classList.contains("btn-close")) {
          b.disabled = true;
        }
      });
    }

    function showLoader(text = "Loading… Please wait") {
      loaderOverlay.style.display = "flex";
      document.querySelector(".loader-text").innerText = text;
    }

    function hideLoader() {
      loaderOverlay.style.display = "none";
    }

    function setLoading(btn, text) {
      btn.dataset.originalText = btn.innerText;
      btn.innerText = text;
    }

    function resetButton(btn) {
      btn.innerText = btn.dataset.originalText;
    }

    /* ================= DATE ================= */
    async function onDate() {
      allocStage = 1;
      dateStatus.innerText = "Loading… Please wait";

      gdBox.style.display = "none";
      semBox.style.display = "none";
      piBox.style.display = "none";

      saveGDBtn.style.display = "none";
      saveSemBtn.style.display = "none";
      savePIBtn.style.display = "none";

      await loadExisting();
      dateStatus.innerText = "";
      updateAllocationButtons();
    }

    /* ================= LOAD EXISTING ================= */
    async function loadExisting() {
      const res = await fetch(BACKEND, {
        method: "POST",
        body: new URLSearchParams({
          action: "getAllocationsByDate",
          date: date.value
        })
      }).then(r => r.json());

      const gd = [], sem = [], pi = [];

      res.allocations.forEach(a => {
        if (a.category === "GD") gd.push(a);
        if (a.category === "SEMINAR") sem.push(a);
        if (a.category === "PI") pi.push(a);
      });

      const uniq = arr => {
        const o = {};
        arr.forEach(x => o[x.roll] = x);
        return Object.values(o);
      };

      gdExisting.innerHTML = uniq(gd).length
        ? uniq(gd).map(x => `${x.name} (${x.roll}) [${x.topic}]`).join("<br>")
        : "<i>No GD</i>";

      semExisting.innerHTML = uniq(sem).length
        ? uniq(sem).map(x => `${x.name} (${x.roll})`).join("<br>")
        : "<i>No Seminar</i>";

      piExisting.innerHTML = uniq(pi).length
        ? uniq(pi).map(x => `${x.name} (${x.roll})`).join("<br>")
        : "<i>No PI</i>";
    }

    /* ================= EVALUATION ================= */
    function loadStudents() {
      fetch(BACKEND + "?action=getAllStudents")
        .then(r => r.json())
        .then(res => {
          studentSelect.innerHTML = '<option value="">Select Student</option>';
          res.students.forEach(s => {
            studentSelect.innerHTML += `<option value="${s.roll}">${s.roll} – ${s.name}</option>`;
          });
        });
    }
  </script>
</body>
</html>
