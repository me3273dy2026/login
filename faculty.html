<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:"Segoe UI",Arial;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;padding:20px;
}
.card{
  background:#fff;
  max-width:1200px;
  margin:auto;
  padding:28px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{text-align:center;color:#e67e22}
.section{
  background:#f5f7fa;
  padding:18px;
  border-radius:12px;
  margin-top:22px;
}
label{font-weight:600;display:block;margin-top:10px}
select,input,textarea{
  width:100%;padding:10px;margin-top:6px;border-radius:6px;border:1px solid #ccc
}
button{
  margin-top:14px;
  padding:12px;
  border:none;
  border-radius:30px;
  font-weight:600;
  cursor:pointer;
}
.primary{background:#e67e22;color:#fff}
.secondary{background:#203a43;color:#fff}
.danger{background:#c0392b;color:#fff}
button:disabled{background:#aaa}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
#busyBox{text-align:center;margin-top:10px;font-weight:600}
@media(max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>

<body>
<div class="card">

<h1>Faculty Dashboard – ME3273</h1>

<div class="section">
<h3>Student Evaluation</h3>
<label>Student</label>
<select id="studentSelect"></select>

<label>Type</label>
<select id="typeSelect"><option>GD</option><option>SEMINAR</option><option>PI</option></select>

<label>Marks</label>
<input id="marks" type="number">

<label>Positives</label>
<textarea id="positives"></textarea>

<label>Improvements</label>
<textarea id="improvements"></textarea>

<button class="primary" onclick="savePerformance()">Save / Update</button>
</div>

<div class="section grid">
<div>
<h3>GD Allocation</h3>
<label>Date</label><input type="date" id="gdDate">
<label>GD Topic</label><select id="gdTopic"></select>
<button class="secondary" onclick="allocateGD()">Allocate GD</button>
</div>

<div>
<h3>Seminar & PI</h3>
<label>Seminar</label>
<select id="seminarSelect" multiple size="6"></select>
<label>PI</label>
<select id="piSelect" multiple size="6"></select>
<button class="secondary" onclick="saveSeminarPI()">Allocate Seminar / PI</button>
</div>
</div>

<div class="section">
<h3>Export Allocation (PDF)</h3>
<label>Select Date</label>
<input type="date" id="pdfDate">
<button class="primary" onclick="exportPDF()">Download PDF</button>
</div>

<div id="busyBox"></div>

</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbyDAivsJUT-UAWo29nR001y8X88ueHfrGFSoTNF5Zza9jpj78W310Ixe__eVgrbeaQbkQ/exec";

/* BUSY */
function setBusy(m){document.querySelectorAll("button").forEach(b=>b.disabled=true);busyBox.innerText=m}
function clearBusy(){document.querySelectorAll("button").forEach(b=>b.disabled=false);busyBox.innerText=""}

/* STUDENTS */
fetch(BACKEND+"?action=getAllStudents").then(r=>r.json()).then(d=>{
  studentSelect.innerHTML='<option></option>';
  d.students.forEach(s=>studentSelect.innerHTML+=`<option value="${s.roll}">${s.roll} - ${s.name}</option>`);
});

/* LOAD PERFORMANCE */
studentSelect.onchange=typeSelect.onchange=()=>{
  if(!studentSelect.value) return;
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"getLatestPerformance",roll:studentSelect.value,type:typeSelect.value
  })}).then(r=>r.json()).then(res=>{
    if(res.status==="FOUND"){
      marks.value=res.marks; positives.value=res.positives; improvements.value=res.improvements;
    }else{marks.value=""; positives.value=""; improvements.value="";}
  });
};

function savePerformance(){
  setBusy("Saving performance…");
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"savePerformance",roll:studentSelect.value,type:typeSelect.value,
    marks:marks.value,positives:positives.value,improvements:improvements.value
  })}).then(()=>alert("Saved")).finally(clearBusy);
}

/* GD */
fetch(BACKEND+"?action=getAvailableGDTopics").then(r=>r.json()).then(d=>{
  gdTopic.innerHTML='<option></option>'; d.topics.forEach(t=>gdTopic.innerHTML+=`<option>${t}</option>`);
});
function allocateGD(){
  if(!gdDate.value||!gdTopic.value){alert("Select date & topic");return;}
  setBusy("Allocating GD…");
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"saveGDAllocation",topic:gdTopic.value,date:gdDate.value
  })}).then(r=>r.json()).then(res=>{
    if(res.status==="ALREADY_EXISTS") alert("Already allocated");
    else alert("GD allocated");
  }).finally(clearBusy);
}

/* SEMINAR + PI */
gdTopic.onchange=gdDate.onchange=()=>{
  if(!gdTopic.value||!gdDate.value) return;
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"getSeminarCandidates",gdTopic:gdTopic.value,date:gdDate.value
  })}).then(r=>r.json()).then(d=>{
    seminarSelect.innerHTML=""; piSelect.innerHTML="";
    d.students.forEach(s=>seminarSelect.innerHTML+=`<option value="${s.roll}">${s.name}</option>`);
  });
};

seminarSelect.onchange=()=>{
  const rolls=[...seminarSelect.selectedOptions].map(o=>o.value).join(",");
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"getPICandidates",gdTopic:gdTopic.value,date:gdDate.value,seminarRolls:rolls
  })}).then(r=>r.json()).then(d=>{
    piSelect.innerHTML=""; d.students.forEach(s=>piSelect.innerHTML+=`<option value="${s.roll}">${s.name}</option>`);
  });
};

function saveSeminarPI(){
  if(!gdDate.value||!gdTopic.value){alert("Select GD date & topic");return;}
  setBusy("Allocating Seminar / PI…");
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"saveSeminarPIAllocation",
    date:gdDate.value,
    seminarRolls:[...seminarSelect.selectedOptions].map(o=>o.value).join(","),
    piRolls:[...piSelect.selectedOptions].map(o=>o.value).join(",")
  })}).then(()=>alert("Allocated")).finally(clearBusy);
}

/* PDF */
function exportPDF(){
  const date=pdfDate.value;
  if(!date){alert("Select date");return;}
  fetch(BACKEND,{method:"POST",body:new URLSearchParams({
    action:"getAllocationsByDate",date
  })}).then(r=>r.json()).then(d=>{
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF();
    doc.text(`Evaluation Allocation – ${date}`,10,10);
    let y=20;
    d.data.forEach((r,i)=>{
      doc.text(`${i+1}. ${r.roll} - ${r.name} (${r.category})`,10,y);
      y+=8;
    });
    doc.save(`Allocation_${date}.pdf`);
  });
}
</script>
</body>
</html>
