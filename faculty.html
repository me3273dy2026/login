<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{font-family:Segoe UI;background:#203a43;margin:0}
.card{max-width:1100px;margin:20px auto;background:#fff;
padding:24px;border-radius:14px}
button{width:100%;padding:12px;margin-top:10px;
border:none;border-radius:24px;font-weight:600;cursor:pointer}
button:disabled{background:#aaa;cursor:not-allowed}
.btn{background:#203a43;color:#fff}
.btn-blue{background:#2980b9;color:#fff}
.btn-red{background:#c0392b;color:#fff}
.box{background:#f4f7fb;padding:16px;margin-top:14px;border-radius:12px}
.sub{background:#fff;padding:10px;border-radius:8px;margin-top:8px}
input,select,textarea{
  width:100%;padding:10px;border-radius:8px;border:1px solid #ccc
}
textarea{resize:vertical}
</style>
</head>

<body>
<div class="card">

<h2>Faculty Dashboard</h2>

<!-- ================= HOME ================= -->
<div id="home">
  <button class="btn" onclick="openAlloc()">Allocation</button>
  <button class="btn-blue" onclick="openEval()">Evaluation</button>
  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<!-- ================= ALLOCATION ================= -->
<div id="alloc" style="display:none">

<div class="box">
  <b>Date</b>
  <input type="date" id="date" onchange="onDate()">
  <div id="dateStatus" style="margin-top:6px;color:#c0392b;font-weight:600;"></div>
</div>

<div class="box">
  <b>Group Discussion</b>
  <div id="gdExisting" class="sub"></div>
  <button id="gdOpenBtn" class="btn" disabled onclick="loadGD()">Allocate / Update GD</button>
  <div id="gdBox" class="sub" style="display:none"></div>
  <button id="saveGDBtn" class="btn" style="display:none" onclick="saveGD()">Save / Update GD</button>
</div>

<div class="box">
  <b>Seminar</b>
  <div id="semExisting" class="sub"></div>
  <button id="semOpenBtn" class="btn" disabled onclick="loadSeminar()">Allocate / Update Seminar</button>
  <div id="semBox" class="sub" style="display:none"></div>
  <button id="saveSemBtn" class="btn" style="display:none" onclick="saveSeminar()">Save / Update Seminar</button>
</div>

<div class="box">
  <b>Personal Interview</b>
  <div id="piExisting" class="sub"></div>
  <button id="piOpenBtn" class="btn" disabled onclick="loadPI()">Allocate / Update PI</button>
  <div id="piBox" class="sub" style="display:none"></div>
  <button id="savePIBtn" class="btn" style="display:none" onclick="savePI()">Save / Update PI</button>
</div>

<button class="btn-red" onclick="closeAlloc()">Close</button>
</div>

<!-- ================= EVALUATION ================= -->
<div id="evaluation" style="display:none">

<div class="box">
  <b>Select Student</b>
  <select id="evalRoll" onchange="loadStudentDetails()">
    <option value="">Select Roll Number</option>
  </select>
</div>

<div id="studentInfo" class="box" style="display:none"></div>

<div class="box">
  <b>Evaluation Type</b>
  <select id="evalType" onchange="loadLatestPerformance()">
    <option value="">Select</option>
    <option value="GD">Group Discussion</option>
    <option value="SEMINAR">Seminar</option>
    <option value="PI">Personal Interview</option>
  </select>
</div>

<div class="box">
  <b>Positives</b>
  <textarea id="positives"></textarea>
</div>

<div class="box">
  <b>Improvements</b>
  <textarea id="improvements"></textarea>
</div>

<div class="box">
  <b>Marks</b>
  <input type="number" id="marks" min="0" max="100">
</div>

<button class="btn-blue" onclick="saveEvaluation()">Save Evaluation</button>
<button class="btn-red" onclick="closeEval()">Close</button>

</div>

</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbwi-6_KbaFA3-JKZOGcxL-h5DUViqw0_1_OVAJsk02P5lJdpng7QSSwJ56akQXduxwEIw/exec";

/* ================= NAV ================= */
function openAlloc(){
  home.style.display="none";
  evaluation.style.display="none";
  alloc.style.display="block";
}
function closeAlloc(){
  alloc.style.display="none";
  home.style.display="block";
}
function openEval(){
  home.style.display="none";
  alloc.style.display="none";
  evaluation.style.display="block";
  loadAllStudents();
}
function closeEval(){
  evaluation.style.display="none";
  home.style.display="block";
}
function logout(){ location.href="login.html"; }

/* ================= EVALUATION ================= */
async function loadAllStudents(){
  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getAllStudents"})
  }).then(r=>r.json());

  evalRoll.innerHTML='<option value="">Select Roll Number</option>';
  res.students.forEach(s=>{
    evalRoll.innerHTML+=`<option value="${s.roll}">${s.roll} â€“ ${s.name}</option>`;
  });
}

async function loadStudentDetails(){
  if(!evalRoll.value) return;

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getStudentDetailsByRoll",
      roll:evalRoll.value
    })
  }).then(r=>r.json());

  studentInfo.style.display="block";
  studentInfo.innerHTML=`
    <b>${res.name}</b><br>
    Project: ${res.projectName}<br>
    Team size: ${res.team.length}
  `;
}

async function loadLatestPerformance(){
  if(!evalRoll.value || !evalType.value) return;

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getLatestPerformance",
      roll:evalRoll.value,
      type:evalType.value
    })
  }).then(r=>r.json());

  positives.value = res.status==="FOUND" ? res.positives : "";
  improvements.value = res.status==="FOUND" ? res.improvements : "";
  marks.value = res.status==="FOUND" ? res.marks : "";
}

async function saveEvaluation(){
  if(!evalRoll.value || !evalType.value){
    alert("Select student and evaluation type");
    return;
  }

  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"savePerformance",
      roll:evalRoll.value,
      type:evalType.value,
      positives:positives.value,
      improvements:improvements.value,
      marks:marks.value
    })
  });

  alert("Evaluation saved successfully");
}
</script>

</body>
</html>
