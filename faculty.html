<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;
  margin:0;
  display:flex;
  justify-content:center;
  align-items:flex-start;
}
.card{
  background:#fff;
  width:100%;
  max-width:1000px;
  margin:24px 12px;
  padding:28px;
  border-radius:14px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
  animation:fadeIn .6s ease;
}
@keyframes fadeIn{
  from{opacity:0;transform:translateY(20px);}
  to{opacity:1;transform:translateY(0);}
}

h1{text-align:center;color:#e67e22;margin-bottom:6px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:20px;}

select,input,textarea,button{
  width:100%;
  padding:10px 12px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:15px;
  margin-top:6px;
}
textarea{min-height:90px;resize:vertical;}

button{
  background:linear-gradient(135deg,#f39c12,#e67e22);
  color:#fff;border:none;
  font-weight:600;
  border-radius:30px;
  margin-top:14px;
  cursor:pointer;
}

.logout-btn{
  background:linear-gradient(135deg,#c0392b,#a93226);
  margin-top:22px;
}

.section-gap{margin-top:16px;}

.row{
  display:flex;
  gap:16px;
  margin-top:18px;
}
.box{
  flex:1;
  background:#f8f9fa;
  padding:16px;
  border-radius:12px;
}
.box h3{
  margin-top:0;
  color:#203a43;
  font-size:16px;
  border-bottom:1px solid #ddd;
  padding-bottom:6px;
}

.loading{
  text-align:center;
  font-weight:600;
  color:#555;
  margin-top:20px;
}

.preview{
  background:#ffffff;
  border:1px dashed #ccc;
  border-radius:6px;
  padding:10px 12px;
  margin-top:6px;
  font-size:14px;
}
.preview ol{margin:0;padding-left:18px;}

.footer{
  margin-top:22px;
  text-align:center;
  font-size:13px;
  color:#5f6f78;
  font-weight:600;
}
.footer div{font-size:12px;color:#7a8a93;}

@media(max-width:800px){
  .row{flex-direction:column;}
}
</style>
</head>

<body>

<div class="card">
  <h1>Faculty Dashboard</h1>
  <h2>Performance Evaluation (ME3273)</h2>

  <label>Select Student</label>
  <select id="studentSelect">
    <option value="">Loading students…</option>
  </select>

  <div id="loading" class="loading" style="display:none">
    Loading… please wait
  </div>

  <div id="content" style="display:none">
    <div class="row">

      <!-- LEFT BOX -->
      <div class="box">
        <h3>Student Details</h3>
        <div id="studentInfo"></div>

        <div class="section-gap"></div>

        <h3>Group Discussion</h3>
        <div id="gdInfo"></div>

        <div class="section-gap"></div>

        <h3>Seminar Topic</h3>
        <div id="seminarInfo"></div>
      </div>

      <!-- RIGHT BOX -->
      <div class="box">
        <h3>Evaluation</h3>

        <label>Evaluation Type</label>
        <select id="typeSelect">
          <option value="GD">Group Discussion</option>
          <option value="SEMINAR">Seminar</option>
          <option value="PI">Personal Interview</option>
        </select>

        <label>Positives (one per line)</label>
        <textarea id="positives"
          oninput="renderBullets('positives','posPreview')"></textarea>
        <div id="posPreview" class="preview"></div>

        <label>Points to Improve (one per line)</label>
        <textarea id="improvements"
          oninput="renderBullets('improvements','impPreview')"></textarea>
        <div id="impPreview" class="preview"></div>

        <div id="actionArea" class="loading">
          Loading… please wait
        </div>
      </div>

    </div>
  </div>

  <button class="logout-btn" onclick="logoutFaculty()">Logout</button>

  <div class="footer">
    Developed by Dr. Rajesh Akula
    <div>© 2026 · IIEST Shibpur</div>
  </div>
</div>

<script>
/* ===== FACULTY ACCESS GUARD ===== */
if(sessionStorage.getItem("facultyLoggedIn") !== "YES"){
  window.location.replace("login.html");
}

const BACKEND =
"https://script.google.com/macros/s/AKfycbxw5_pMfEPHA3u13MaShb1kFfzaqcKwdkXhbEI9tqgVuHM75-Ox7Y5uuR_9xQ2bRxIZ7Q/exec";

/* Load students */
fetch(BACKEND + "?action=getAllStudents")
.then(r=>r.json())
.then(res=>{
  studentSelect.innerHTML = `<option value="">Select Student</option>`;
  res.students.forEach(s=>{
    studentSelect.innerHTML +=
      `<option value="${s.roll}">${s.roll} – ${s.name}</option>`;
  });
});

studentSelect.onchange = loadStudent;
typeSelect.onchange = checkPerformance;

function loadStudent(){
  if(!studentSelect.value) return;

  loading.style.display="block";
  content.style.display="none";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getStudentDetailsByRoll",
      roll: studentSelect.value
    })
  })
  .then(r=>r.json())
  .then(d=>{
    studentInfo.innerHTML =
      `<b>Name:</b> ${d.name}<br><b>Roll:</b> ${d.roll}`;

    gdInfo.innerHTML = d.project
      ? `<b>Topic:</b> ${d.projectName}
         <ul>${d.team.map(t =>
           `<li>${t.name} (${t.roll})</li>`
         ).join("")}</ul>`
      : "Not assigned";

    seminarInfo.innerHTML = d.seminarTopic || "Not submitted";

    loading.style.display="none";
    content.style.display="block";
    checkPerformance();
  });
}

function checkPerformance(){
  actionArea.innerHTML="Loading… please wait";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getLatestPerformance",
      roll: studentSelect.value,
      type: typeSelect.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    positives.value = res.status==="FOUND" ? res.positives : "";
    improvements.value = res.status==="FOUND" ? res.improvements : "";

    renderBullets("positives","posPreview");
    renderBullets("improvements","impPreview");

    actionArea.innerHTML =
      `<button onclick="savePerformance()">
        ${res.status==="FOUND" ? "Update Performance" : "Save Performance"}
      </button>`;
  });
}

function savePerformance(){
  const btn = document.querySelector("#actionArea button");

  btn.disabled=true;
  btn.innerText="Updating… please wait";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"savePerformance",
      roll: studentSelect.value,
      type: typeSelect.value,
      positives: positives.value,
      improvements: improvements.value
    })
  })
  .then(r=>r.json())
  .then(()=>{
    btn.disabled=false;
    btn.innerText="Update Performance";
    alert("Performance saved");
  });
}

function renderBullets(textareaId, previewId){
  const lines = document.getElementById(textareaId).value
    .split("\n")
    .map(l=>l.trim())
    .filter(l=>l!=="")
    .map(l=>l.charAt(0).toUpperCase()+l.slice(1));

  document.getElementById(previewId).innerHTML =
    lines.length
      ? "<ol>"+lines.map(l=>`<li>${l}</li>`).join("")+"</ol>"
      : "";
}

function logoutFaculty(){
  if(confirm("Are you sure you want to logout?")){
    sessionStorage.removeItem("facultyLoggedIn");
    window.location.href="login.html";
  }
}
</script>

</body>
</html>
