<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  margin:0;
  min-height:100vh;
  display:flex;
  justify-content:center;
}
.card{
  background:#fff;
  width:100%;
  max-width:1100px;
  margin:24px 12px;
  padding:28px;
  border-radius:14px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{text-align:center;color:#e67e22;margin-bottom:4px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:18px;}

label{font-weight:600;margin-top:10px;display:block;}
select,input,textarea,button{
  width:100%;
  padding:10px 12px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:15px;
  margin-top:6px;
}
textarea{min-height:90px;resize:vertical;}

button{
  background:linear-gradient(135deg,#f39c12,#e67e22);
  color:#fff;
  border:none;
  font-weight:600;
  border-radius:30px;
  margin-top:14px;
  cursor:pointer;
}
button:disabled{
  background:#999;
  cursor:not-allowed;
}

.row{
  display:flex;
  gap:16px;
  margin-top:18px;
}
.box{
  flex:1;
  background:#f8f9fa;
  padding:16px;
  border-radius:12px;
}
.box h3{
  margin-top:0;
  color:#203a43;
  border-bottom:1px solid #ddd;
  padding-bottom:6px;
}

.loading{
  text-align:center;
  font-weight:600;
  margin-top:16px;
}

.allocBox{
  background:#eef3f6;
  padding:14px;
  border-radius:10px;
  margin-top:14px;
}

.allocSummary{
  background:#f4f6f8;
  padding:14px;
  border-radius:10px;
  margin-top:14px;
}

.footer{
  margin-top:22px;
  text-align:center;
  font-size:13px;
  color:#5f6f78;
  font-weight:600;
}
.footer div{font-size:12px;color:#7a8a93;}

@media(max-width:900px){
  .row{flex-direction:column;}
}
</style>
</head>

<body>

<div class="card">

<h1>Faculty Dashboard</h1>
<h2>Performance Review & Weekly Allocation (ME3273)</h2>

<!-- ================= DATE ================= -->
<label>Date of Allocation</label>
<input type="date" id="allocDate">

<!-- ================= WEEKLY ALLOCATION ================= -->
<div class="row">

  <!-- GD -->
  <div class="box">
    <h3>Group Discussion Allocation</h3>

    <label>GD Topic</label>
    <select id="gdTopic">
      <option value="">Select Topic</option>
      <option>T1</option><option>T2</option><option>T3</option>
      <option>T4</option><option>T5</option><option>T6</option>
      <option>T7</option><option>T8</option><option>T9</option>
    </select>

    <button onclick="saveGD(event)">Allocate GD</button>
  </div>

  <!-- SEMINAR -->
  <div class="box">
    <h3>Seminar Allocation</h3>
    <div id="seminarList" class="allocBox"></div>
    <button onclick="saveSeminar(event)">Save Seminar Allocation</button>
  </div>

  <!-- PI -->
  <div class="box">
    <h3>Personal Interview Allocation</h3>
    <div id="piList" class="allocBox"></div>
    <button onclick="savePI(event)">Save PI Allocation</button>
  </div>

</div>

<!-- ================= SUMMARY ================= -->
<div id="allocationSummary" class="allocSummary" style="display:none"></div>

<!-- ================= FOOTER ================= -->
<div class="footer">
  Developed by Dr. Rajesh Akula
  <div>© 2026 · IIEST Shibpur</div>
</div>

</div>

<script>
if(sessionStorage.getItem("facultyLoggedIn")!=="YES"){
  location.replace("login.html");
}

const BACKEND =
"https://script.google.com/macros/s/AKfycbxkFC04HnDu-qV-yOEJpg3GYOEaLIVbont-lgP8Gja0GsgqI39dPYr2fY88UeJNNn3xgA/exec";

/* ---------- BUTTON CONTROL ---------- */
function disableAllButtons(){
  document.querySelectorAll("button").forEach(b=>b.disabled=true);
}
function enableAllButtons(){
  document.querySelectorAll("button").forEach(b=>b.disabled=false);
}

/* ---------- DATE CHANGE ---------- */
allocDate.onchange = ()=>{
  loadEligibleStudents();
  loadAllocationsForDate();
};

/* ---------- GD ---------- */
function saveGD(e){
  if(!gdTopic.value || !allocDate.value){
    alert("Select GD topic and date");
    return;
  }

  const btn = e.target;
  const txt = btn.innerText;

  disableAllButtons();
  btn.innerText="Allocating… Please wait";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      topic:gdTopic.value,
      date:allocDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    alert(`GD allocated for ${res.count} students`);
    btn.innerText=txt;
    enableAllButtons();
    seminarList.innerHTML="";
    piList.innerHTML="";
    loadAllocationsForDate();
  })
  .catch(()=>{
    btn.innerText=txt;
    enableAllButtons();
    alert("Error allocating GD");
  });
}

/* ---------- SEMINAR ---------- */
function saveSeminar(e){
  const sel=[...seminarList.querySelectorAll("input:checked")];
  if(sel.length===0){alert("Select students");return;}

  const btn=e.target, txt=btn.innerText;
  disableAllButtons();
  btn.innerText="Allocating… Please wait";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"SEMINAR",
      date:allocDate.value,
      rolls:sel.map(i=>i.value).join(",")
    })
  })
  .then(r=>r.json())
  .then(res=>{
    alert(`Seminar allocated for ${res.count} students`);
    btn.innerText=txt;
    enableAllButtons();
    seminarList.innerHTML="";
    loadAllocationsForDate();
  });
}

/* ---------- PI ---------- */
function savePI(e){
  const sel=[...piList.querySelectorAll("input:checked")];
  if(sel.length===0){alert("Select students");return;}

  const btn=e.target, txt=btn.innerText;
  disableAllButtons();
  btn.innerText="Allocating… Please wait";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:"PI",
      date:allocDate.value,
      rolls:sel.map(i=>i.value).join(",")
    })
  })
  .then(r=>r.json())
  .then(res=>{
    alert(`PI allocated for ${res.count} students`);
    btn.innerText=txt;
    enableAllButtons();
    piList.innerHTML="";
    loadAllocationsForDate();
  });
}

/* ---------- SUMMARY ---------- */
function loadAllocationsForDate(){
  if(!allocDate.value) return;

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:allocDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    allocationSummary.style.display="block";
    if(res.status!=="OK" || res.allocations.length===0){
      allocationSummary.innerHTML="<b>No allocations for this date</b>";
      return;
    }

    let html=`<b>Allocations on ${allocDate.value}</b><br><br>`;
    res.allocations.forEach(a=>{
      html+=`${a.category}: ${a.name} (${a.roll}) ${a.topic||""}<br>`;
    });
    allocationSummary.innerHTML=html;
  });
}

/* ---------- PLACEHOLDERS ---------- */
function loadEligibleStudents(){
  seminarList.innerHTML="<i>Eligible students will appear here</i>";
  piList.innerHTML="<i>Eligible students will appear here</i>";
}
</script>

</body>
</html>
