<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{font-family:Segoe UI;background:#203a43;margin:0}
.card{max-width:1100px;margin:20px auto;background:#fff;
padding:24px;border-radius:14px}
button{width:100%;padding:12px;margin-top:10px;
border:none;border-radius:24px;font-weight:600;cursor:pointer}
button:disabled{background:#aaa;cursor:not-allowed}
.btn{background:#203a43;color:#fff}
.btn-red{background:#c0392b;color:#fff}
.box{background:#f4f7fb;padding:16px;margin-top:14px;border-radius:12px}
.sub{background:#fff;padding:10px;border-radius:8px;margin-top:8px}
input{width:100%;padding:10px;border-radius:8px}
</style>
</head>

<body>
<div class="card">

<h2>Faculty Dashboard</h2>

<div id="home">
  <button class="btn" onclick="openAlloc()">Allocate</button>
  <button class="btn-red" onclick="logout()">Logout</button>
</div>

<div id="alloc" style="display:none">

<!-- DATE -->
<div class="box">
  <b>Date</b>
  <input type="date" id="date" onchange="onDate()">
</div>

<!-- GD -->
<div class="box">
  <b>Group Discussion</b>
  <div id="gdExisting" class="sub"></div>
  <button id="gdOpenBtn" class="btn" disabled onclick="loadGD()">Allocate / Update GD</button>
  <div id="gdBox" class="sub" style="display:none"></div>
  <button id="saveGDBtn" class="btn" style="display:none" onclick="saveGD()">Save / Update GD</button>
</div>

<!-- SEMINAR -->
<div class="box">
  <b>Seminar</b>
  <div id="semExisting" class="sub"></div>
  <button id="semOpenBtn" class="btn" disabled onclick="loadSeminar()">Allocate / Update Seminar</button>
  <div id="semBox" class="sub" style="display:none"></div>
  <button id="saveSemBtn" class="btn" style="display:none" onclick="saveSeminar()">Save / Update Seminar</button>
</div>

<!-- PI -->
<div class="box">
  <b>Personal Interview</b>
  <div id="piExisting" class="sub"></div>
  <button id="piOpenBtn" class="btn" disabled onclick="loadPI()">Allocate / Update PI</button>
  <div id="piBox" class="sub" style="display:none"></div>
  <button id="savePIBtn" class="btn" style="display:none" onclick="savePI()">Save / Update PI</button>
</div>

<button class="btn-red" onclick="back()">Close</button>
</div>
</div>

<script>
const BACKEND="https://script.google.com/macros/s/AKfycbwi-6_KbaFA3-JKZOGcxL-h5DUViqw0_1_OVAJsk02P5lJdpng7QSSwJ56akQXduxwEIw/exec";

/* ---------- UTIL ---------- */
function setLoading(btn){
  btn.dataset.txt = btn.innerText;
  btn.innerText = "Loadingâ€¦ Please wait";
  btn.disabled = true;
}
function clearLoading(btn){
  btn.innerText = btn.dataset.txt;
}

/* ---------- NAV ---------- */
function openAlloc(){
  home.style.display="none";
  alloc.style.display="block";

  // Rule 1
  date.disabled=false;
  gdOpenBtn.disabled=true;
  semOpenBtn.disabled=true;
  piOpenBtn.disabled=true;
}
function back(){
  alloc.style.display="none";
  home.style.display="block";
}

/* ---------- DATE ---------- */
async function onDate(){
  date.disabled = true;

  // reset all buttons
  gdOpenBtn.disabled = true;
  semOpenBtn.disabled = true;
  piOpenBtn.disabled = true;

  gdBox.style.display="none";
  semBox.style.display="none";
  piBox.style.display="none";
  saveGDBtn.style.display="none";
  saveSemBtn.style.display="none";
  savePIBtn.style.display="none";

  await loadExisting();   // ðŸ”¥ decision made here
}

/* ---------- EXISTING ---------- */
async function loadExisting(){
  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:date.value
    })
  }).then(r=>r.json());

  const gd=[], sem=[], pi=[];
  res.allocations.forEach(a=>{
    if(a.category==="GD") gd.push(a);
    if(a.category==="SEMINAR") sem.push(a);
    if(a.category==="PI") pi.push(a);
  });

  // Show existing allocations
  gdExisting.innerHTML = gd.length
    ? gd.map(x=>`${x.name} [${x.topic}]`).join("<br>")
    : "<i>No GD</i>";

  semExisting.innerHTML = sem.length
    ? sem.map(x=>`${x.name}`).join("<br>")
    : "<i>No Seminar</i>";

  piExisting.innerHTML = pi.length
    ? pi.map(x=>`${x.name}`).join("<br>")
    : "<i>No PI</i>";

  /* ===============================
     STRICT FLOW ENFORCEMENT
     =============================== */

  // Always allow GD edit
  gdOpenBtn.disabled = false;

  // Seminar only after GD exists
  semOpenBtn.disabled = gd.length === 0;

  // PI only after Seminar exists
  piOpenBtn.disabled = sem.length === 0;
}

  // display existing
  gdExisting.innerHTML = gd.length
    ? gd.map(x=>`${x.name} [${x.topic}]`).join("<br>")
    : "<i>No GD</i>";

  semExisting.innerHTML = sem.length
    ? sem.map(x=>`${x.name}`).join("<br>")
    : "<i>No Seminar</i>";

  piExisting.innerHTML = pi.length
    ? pi.map(x=>`${x.name}`).join("<br>")
    : "<i>No PI</i>";

  /* ðŸ”‘ DECIDE EDIT PERMISSION */

  if(!gd.length && !sem.length && !pi.length){
    // fresh date
    gdOpenBtn.disabled = false;
  }
  else if(gd.length && !sem.length){
    // GD done, Seminar pending
    semOpenBtn.disabled = false;
  }
  else if(gd.length && sem.length && !pi.length){
    // PI pending
    piOpenBtn.disabled = false;
  }
  else{
    // everything exists â†’ allow edit of all
    gdOpenBtn.disabled = false;
    semOpenBtn.disabled = false;
    piOpenBtn.disabled = false;
  }
}
/* ---------- GD ---------- */
async function loadGD(){
  setLoading(gdOpenBtn);

  gdBox.style.display="block";
  saveGDBtn.style.display="block";
  gdBox.innerHTML="";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getGDTopicStatus",date:date.value})
  }).then(r=>r.json());

  res.topics.forEach(t=>{
    gdBox.innerHTML+=`<label><input type="checkbox" value="${t.topic}" ${t.checked?"checked":""}> ${t.topic}</label><br>`;
  });

  clearLoading(gdOpenBtn);
}

async function saveGD(){
  setLoading(saveGDBtn);

  const topics=[...gdBox.querySelectorAll("input:checked")].map(i=>i.value);
  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"saveGDAllocation",date:date.value,topics:topics.join(",")})
  });

  gdBox.style.display="none";
  saveGDBtn.style.display="none";
  gdOpenBtn.disabled=true;          // Rule 3
  semOpenBtn.disabled=false;

  await loadExisting();
  clearLoading(saveGDBtn);
}

/* ---------- SEMINAR ---------- */
async function loadSeminar(){
  setLoading(semOpenBtn);

  semBox.style.display="block";
  saveSemBtn.style.display="block";
  semBox.innerHTML="";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getSeminarStudentStatus",date:date.value})
  }).then(r=>r.json());

  res.students.forEach(s=>{
    semBox.innerHTML+=`<label><input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}> ${s.name}</label><br>`;
  });

  clearLoading(semOpenBtn);
}

async function saveSeminar(){
  setLoading(saveSemBtn);

  const rolls=[...semBox.querySelectorAll("input:checked")].map(i=>i.value);
  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"saveIndividualAllocation",category:"SEMINAR",date:date.value,rolls:rolls.join(",")})
  });

  semBox.style.display="none";
  saveSemBtn.style.display="none";
  semOpenBtn.disabled=true;         // Rule 4
  piOpenBtn.disabled=false;

  await loadExisting();
  clearLoading(saveSemBtn);
}

/* ---------- PI ---------- */
async function loadPI(){
  setLoading(piOpenBtn);

  piBox.style.display="block";
  savePIBtn.style.display="block";
  piBox.innerHTML="";

  const res = await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"getPIStudentStatus",date:date.value})
  }).then(r=>r.json());

  res.students.forEach(s=>{
    piBox.innerHTML+=`<label><input type="checkbox" value="${s.roll}" ${s.checked?"checked":""}> ${s.name}</label><br>`;
  });

  clearLoading(piOpenBtn);
}

async function savePI(){
  setLoading(savePIBtn);

  const rolls=[...piBox.querySelectorAll("input:checked")].map(i=>i.value);
  await fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({action:"saveIndividualAllocation",category:"PI",date:date.value,rolls:rolls.join(",")})
  });

  piBox.style.display="none";
  savePIBtn.style.display="none";

  // Rule 5: everything disabled
  gdOpenBtn.disabled=true;
  semOpenBtn.disabled=true;
  piOpenBtn.disabled=true;

  await loadExisting();
  clearLoading(savePIBtn);
}

/* ---------- LOGOUT ---------- */
function logout(){location.href="login.html";}
</script>
</body>
</html>
