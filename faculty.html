<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Faculty Dashboard | ME3273</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  min-height:100vh;margin:0;
  display:flex;justify-content:center;
}
.card{
  background:#fff;
  width:100%;max-width:1100px;
  margin:24px 12px;
  padding:28px;
  border-radius:16px;
  box-shadow:0 15px 40px rgba(0,0,0,.25);
}
h1{text-align:center;color:#e67e22;margin-bottom:6px;}
h2{text-align:center;color:#555;font-size:15px;margin-bottom:22px;}

button{
  width:100%;padding:12px;margin-top:12px;
  border:none;border-radius:30px;
  font-size:15px;font-weight:600;
  cursor:pointer;
}
button:disabled{background:#999;cursor:not-allowed;}

.btn-main{background:#203a43;color:#fff;}
.btn-alloc{background:#27ae60;color:#fff;}
.btn-eval{background:#2980b9;color:#fff;}
.btn-close{background:#7f8c8d;color:#fff;}
.btn-logout{background:#c0392b;color:#fff;}

.section{display:none;margin-top:20px;}
.box{
  background:#f5f7fa;
  padding:16px;
  border-radius:12px;
  margin-top:14px;
}
.loading{text-align:center;font-weight:700;margin-top:12px;}
ul{margin-left:18px;}

.footer{
  margin-top:30px;text-align:center;
  font-size:13px;color:#5f6f78;font-weight:600;
}
.footer div{font-size:12px;color:#7a8a93;}
</style>
</head>

<body>

<div class="card">

<h1>Faculty Dashboard</h1>
<h2>ME3273 Â· Weekly Allocation</h2>

<!-- HOME -->
<div id="home">
  <button class="btn-alloc" onclick="openAllocate()">Allocate Students</button>
  <button class="btn-eval" onclick="openEvaluate()">Evaluate Students</button>
  <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<!-- ================= ALLOCATION ================= -->
<div id="allocate" class="section">

<div class="box">
  <label><b>Date of Allocation</b></label>
  <input type="date" id="allocDate" onchange="loadExistingAllocations()">
</div>

<!-- EXISTING ALLOCATIONS -->
<div class="box">
  <h3>Existing Allocations (Selected Date)</h3>
  <div id="existingAlloc"></div>
</div>

<!-- GD -->
<div class="box">
  <h3>Group Discussion</h3>

  <select id="gdTopic">
    <option value="">Select GD Topic</option>
    <option>T1</option><option>T2</option><option>T3</option>
    <option>T4</option><option>T5</option><option>T6</option>
    <option>T7</option><option>T8</option><option>T9</option>
  </select>

  <button class="btn-main" onclick="allocateGD()">Allocate GD</button>
  <div id="gdResult"></div>
</div>

<!-- SEMINAR -->
<div class="box">
  <h3>Seminar</h3>
  <div id="seminarList">Auto-filtered list will appear here</div>
  <button class="btn-main" onclick="saveSeminar()">Save Seminar Allocation</button>
</div>

<!-- PI -->
<div class="box">
  <h3>Personal Interview</h3>
  <div id="piList">Auto-filtered list will appear here</div>
  <button class="btn-main" onclick="savePI()">Save PI Allocation</button>
</div>

<button class="btn-close" onclick="closeAll()">Close</button>

</div>

<!-- EVALUATION -->
<div id="evaluate" class="section">
  <iframe src="faculty_evaluation.html"
    style="width:100%;height:700px;border:none;border-radius:12px">
  </iframe>
  <button class="btn-close" onclick="closeAll()">Close</button>
</div>

<div class="footer">
  Developed by Dr. Rajesh Akula
  <div>Â© 2026 Â· IIEST Shibpur</div>
</div>

</div>

<script>
const BACKEND =
"https://script.google.com/macros/s/AKfycbxkFC04HnDu-qV-yOEJpg3GYOEaLIVbont-lgP8Gja0GsgqI39dPYr2fY88UeJNNn3xgA/exec";

/* NAV */
function openAllocate(){ home.style.display="none"; allocate.style.display="block"; }
function openEvaluate(){ home.style.display="none"; evaluate.style.display="block"; }
function closeAll(){
  allocate.style.display="none";
  evaluate.style.display="none";
  home.style.display="block";
}

function disableAll(state){
  document.querySelectorAll("button").forEach(b=>b.disabled=state);
}

/* ================= FIX #1: LOAD EXISTING ================= */
function loadExistingAllocations(){
  if(!allocDate.value) return;

  existingAlloc.innerHTML="<div class='loading'>Loading allocationsâ€¦</div>";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getAllocationsByDate",
      date:allocDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    if(res.allocations.length===0){
      existingAlloc.innerHTML="<i>No allocations yet</i>";
      return;
    }

    const grouped={};
    res.allocations.forEach(a=>{
      if(!grouped[a.category]) grouped[a.category]=[];
      grouped[a.category].push(a);
    });

    let html="";
    Object.keys(grouped).forEach(cat=>{
      html+=`<b>${cat}</b><ul>`+
        grouped[cat].map(s=>`<li>${s.roll} â€“ ${s.name}</li>`).join("")+
        `</ul>`;
    });

    existingAlloc.innerHTML=html;
  });
}

/* ================= FIX #2: GD LIST ================= */
function allocateGD(){
  if(!allocDate.value || !gdTopic.value){
    alert("Select date and GD topic");
    return;
  }

  disableAll(true);
  gdResult.innerHTML="<div class='loading'>Allocating GDâ€¦</div>";

  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveGDAllocation",
      topic:gdTopic.value,
      date:allocDate.value
    })
  })
  .then(r=>r.json())
  .then(res=>{
    gdResult.innerHTML=
      `<b>${res.count} students allocated for GD</b>`;
    loadExistingAllocations();   // ðŸ”¥ refresh list
    loadSeminarEligible();       // ðŸ”¥ auto-filter
  })
  .finally(()=>disableAll(false));
}

/* SEMINAR */
function loadSeminarEligible(){
  seminarList.innerHTML="<div class='loading'>Loadingâ€¦</div>";
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligibleSeminar",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    seminarList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}"> ${s.roll} â€“ ${s.name}</label><br>`
    ).join("") || "No eligible students";
  });
}
function saveSeminar(){
  saveIndividuals("SEMINAR","seminarList");
}

/* PI */
function loadPIEligible(){
  piList.innerHTML="<div class='loading'>Loadingâ€¦</div>";
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"getEligiblePI",
      date:allocDate.value
    })
  }).then(r=>r.json()).then(res=>{
    piList.innerHTML=res.students.map(s=>
      `<label><input type="checkbox" value="${s.roll}"> ${s.roll} â€“ ${s.name}</label><br>`
    ).join("") || "No eligible students";
  });
}
function savePI(){
  saveIndividuals("PI","piList");
}

/* SAVE INDIVIDUAL */
function saveIndividuals(cat,box){
  const rolls=[...document.querySelectorAll(`#${box} input:checked`)]
    .map(i=>i.value);

  if(!rolls.length){ alert("Select students"); return; }

  disableAll(true);
  fetch(BACKEND,{
    method:"POST",
    body:new URLSearchParams({
      action:"saveIndividualAllocation",
      category:cat,
      date:allocDate.value,
      rolls:rolls.join(",")
    })
  })
  .then(()=>loadExistingAllocations())
  .finally(()=>disableAll(false));
}

function logout(){
  if(confirm("Logout?")) location.href="login.html";
}
</script>

</body>
</html>
